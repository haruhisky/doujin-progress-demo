<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Âêå‰∫∫„Çè„Çì„Åü„Å£„Å∑</title>
<style>
:root {
  --bg: #faf8f5;
  --card-bg: #ffffff;
  --text: #4a4a4a;
  --text-light: #8a8a8a;
  --border: #e8e4df;
  --shadow: rgba(0,0,0,0.06);

  --name-color: #e8a0b4;
  --name-bg: #fdf0f4;
  --draft-color: #e8b472;
  --draft-bg: #fdf5ec;
  --ink-color: #7baed4;
  --ink-bg: #eef5fb;
  --finish-color: #82b89a;
  --finish-bg: #eef7f2;

  --daily-color: #c4a6d4;
  --daily-bg: #f5eef8;
  --event-color: #d4b896;
  --event-bg: #faf3ea;

  --today-line: #e07070;
  --deadline-line: #c04040;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
  background: #e8e4df;
  color: var(--text);
  overflow-x: hidden;
  overflow-y: auto;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0;
  gap: 0;
}

/* ‚îÄ‚îÄ App Section (wantap / workmate) ‚îÄ‚îÄ */
.app-section {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 2.5rem 1rem;
  gap: 1.5rem;
}
.app-section.wantap-area {
  background: #e8e4df;
}
.app-section.workmate-area {
  background: #2a2a3e;
  color: #e0ddd8;
}
.app-section .app-header {
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}
.app-section .app-title {
  font-size: 1.4rem;
  font-weight: 700;
}
.wantap-area .app-title { color: var(--text); }
.workmate-area .app-title { color: #e0ddd8; }
.app-section .app-tagline {
  font-size: 0.85rem;
  line-height: 1.6;
}
.wantap-area .app-tagline { color: var(--text-light); }
.workmate-area .app-tagline { color: rgba(224,221,216,0.7); }

/* ‚îÄ‚îÄ Download Button ‚îÄ‚îÄ */
.dl-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: #e8a0b4;
  color: #fff;
  border-radius: 12px;
  text-decoration: none;
  font-size: 0.95rem;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(232,160,180,0.3);
  transition: transform 0.15s, box-shadow 0.15s;
}
.dl-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(232,160,180,0.4);
}

/* ‚îÄ‚îÄ WorkMate Section ‚îÄ‚îÄ */
.workmate-area iframe {
  width: 100%;
  max-width: 420px;
  height: 720px;
  border: none;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}
.wm-link {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.6rem 1.25rem;
  background: #667eea;
  color: #fff;
  border-radius: 12px;
  text-decoration: none;
  font-size: 0.9rem;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(102,126,234,0.3);
  transition: transform 0.15s, box-shadow 0.15s;
}
.wm-link:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102,126,234,0.4);
}

/* ‚îÄ‚îÄ WorkMate State Buttons ‚îÄ‚îÄ */
.wm-state-controls {
  display: flex;
  justify-content: center;
  gap: 0.6rem;
  flex-wrap: wrap;
}
.wm-state-btn {
  padding: 0.5rem 1.1rem;
  border: 2px solid rgba(255,255,255,0.15);
  border-radius: 8px;
  background: transparent;
  color: rgba(224,221,216,0.6);
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: inherit;
}
.wm-state-btn:hover {
  border-color: rgba(255,255,255,0.3);
  color: #e0ddd8;
}
.wm-state-btn.active { color: #fff; }
.wm-state-btn[data-state="work"].active {
  border-color: #667eea;
  background: rgba(102,126,234,0.25);
}
.wm-state-btn[data-state="slacking"].active {
  border-color: #f093fb;
  background: rgba(240,147,251,0.25);
}
.wm-state-btn[data-state="break"].active {
  border-color: #11998e;
  background: rgba(17,153,142,0.25);
}
.wm-state-btn[data-state="away"].active {
  border-color: #6c7086;
  background: rgba(108,112,134,0.25);
}
.wm-hint {
  font-size: 0.8rem;
  color: rgba(224,221,216,0.5);
  text-align: center;
}

/* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
.footer-note {
  width: 100%;
  font-size: 0.75rem;
  color: rgba(224,221,216,0.5);
  text-align: center;
  padding: 1rem;
  background: #2a2a3e;
}

.phone-frame {
  width: 390px;
  height: 760px;
  background: var(--bg);
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Cg fill='%23e8e0d8' opacity='0.18'%3E%3Cellipse cx='30' cy='38' rx='10' ry='9'/%3E%3Cellipse cx='20' cy='22' rx='5' ry='5.5'/%3E%3Cellipse cx='40' cy='22' rx='5' ry='5.5'/%3E%3Cellipse cx='14' cy='30' rx='4' ry='4.5'/%3E%3Cellipse cx='46' cy='30' rx='4' ry='4.5'/%3E%3C/g%3E%3C/svg%3E");
  border-radius: 32px;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  position: relative;
  display: flex;
  flex-direction: column;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header {
  padding: 16px 20px 8px;
  text-align: center;
  flex-shrink: 0;
}
.header h1 {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.header-dog-icon {
  width: 22px;
  height: 22px;
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ Nav labels ‚îÄ‚îÄ */
.nav-labels {
  display: flex;
  justify-content: center;
  gap: 12px;
  padding: 0 0 10px;
  flex-shrink: 0;
}
.nav-label {
  font-size: 10px;
  color: var(--text-light);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 12px;
  transition: all 0.3s;
}
.nav-label.active {
  color: var(--text);
  background: var(--card-bg);
  font-weight: 600;
}

/* ‚îÄ‚îÄ Nav dots ‚îÄ‚îÄ */
.nav-dots {
  display: flex;
  justify-content: center;
  gap: 8px;
  padding: 6px 0 10px;
  flex-shrink: 0;
}
.nav-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--border);
  transition: background 0.3s, transform 0.3s;
  cursor: pointer;
}
.nav-dot.active {
  background: var(--text-light);
  transform: scale(1.3);
}

/* ‚îÄ‚îÄ Swipe container ‚îÄ‚îÄ */
.swipe-container {
  flex: 1;
  overflow: hidden;
  position: relative;
}
.swipe-track {
  display: flex;
  width: 400%;
  height: 100%;
  transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.page {
  width: 25%;
  height: 100%;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 0 16px 20px;
}

/* ‚îÄ‚îÄ Today page: variable grid ‚îÄ‚îÄ */
.date-display {
  text-align: center;
  margin-bottom: 10px;
}
.date-display .date {
  font-size: 20px;
  font-weight: 600;
}
.date-display .weekday {
  font-size: 12px;
  color: var(--text-light);
  margin-top: 2px;
}

/* ‚îÄ‚îÄ Daily / Event task row ‚îÄ‚îÄ */
.daily-event-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
}
.de-card {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 12px;
  background: var(--card-bg);
  box-shadow: 0 1px 4px var(--shadow);
  user-select: none;
  -webkit-user-select: none;
  transition: transform 0.1s;
}
.de-card-label {
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}
.de-card-slots {
  display: flex;
  gap: 3px;
}
.de-paw-slot {
  width: 22px;
  height: 22px;
  position: relative;
  cursor: pointer;
}
.de-paw-slot svg { width: 100%; height: 100%; }
.de-paw-slot .paw-outline { opacity: 0.3; }
.de-paw-slot .paw-filled { opacity: 0; transition: opacity 0.15s; }
.de-paw-slot.done .paw-filled { opacity: 1; }
.de-paw-slot.done .paw-outline { opacity: 0; }
.de-paw-slot.bounce { animation: dePawBounce 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
.de-paw-slot.unbounce { animation: dePawUnbounce 0.3s ease-in; }

@keyframes dePawBounce {
  0%   { transform: scale(0.3); }
  50%  { transform: scale(1.25); }
  75%  { transform: scale(0.9); }
  100% { transform: scale(1); }
}
@keyframes dePawUnbounce {
  0%   { transform: scale(1); opacity: 1; }
  50%  { transform: scale(1.15); opacity: 0.7; }
  100% { transform: scale(0.3); opacity: 0; }
}

.tap-grid {
  display: grid;
  grid-template-columns: var(--left-ratio, 1fr) var(--right-ratio, 1fr);
  grid-template-rows: var(--top-ratio, 1fr) var(--bottom-ratio, 1fr);
  gap: 10px;
  flex: 1;
  height: calc(100% - 100px);
  transition: grid-template-columns 0.5s ease, grid-template-rows 0.5s ease;
}

.tap-cell {
  border-radius: 16px;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
  display: flex;
  flex-direction: column;
  transition: transform 0.1s;
}
.tap-cell:active { transform: scale(0.98); }

.tap-cell-main {
  grid-column: 1 / -1;
}
.tap-cell-next {
  grid-row: 2;
  grid-column: 1;
}
.tap-cell-rest-wrap {
  grid-row: 2;
  grid-column: 2;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.tap-cell-rest-wrap .tap-cell {
  flex: 1;
  min-height: 0;
}

.tap-cell.name-cell { background: var(--name-bg); }
.tap-cell.draft-cell { background: var(--draft-bg); }
.tap-cell.ink-cell { background: var(--ink-bg); }
.tap-cell.finish-cell { background: var(--finish-bg); }

.tap-cell-header {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 12px 4px;
  font-size: 12px;
  font-weight: 600;
  pointer-events: none;
  z-index: 2;
}
.tap-cell-header .icon { font-size: 16px; }
.tap-cell-header .progress {
  margin-left: auto;
  font-size: 13px;
  font-weight: 700;
}

.tap-cell.name-cell .tap-cell-header { color: #b06078; }
.tap-cell.draft-cell .tap-cell-header { color: #a07840; }
.tap-cell.ink-cell .tap-cell-header { color: #5080a0; }
.tap-cell.finish-cell .tap-cell-header { color: #508068; }

.tap-cell-stickers {
  flex: 1;
  position: relative;
  pointer-events: none;
}

/* ‚îÄ‚îÄ Paw-shaped stickers ‚îÄ‚îÄ */
.sticker {
  width: 40px; height: 40px;
  position: absolute;
  animation: stickerBounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  cursor: pointer;
  pointer-events: auto;
  transition: opacity 0.2s;
  z-index: 1;
  touch-action: none;
  filter: drop-shadow(1px 2px 2px rgba(0,0,0,0.18));
}
.sticker svg { width: 100%; height: 100%; display: block; }

.sticker.removing {
  animation: stickerSlideOut 0.3s ease-in forwards;
}
.sticker.removing-shrink {
  animation: stickerRemove 0.3s ease-in forwards;
}

@keyframes stickerBounce {
  0%   { transform: scale(0); opacity: 0; }
  40%  { transform: scale(1.3) scaleY(0.85); opacity: 1; }
  55%  { transform: scale(0.9) scaleY(1.08); }
  70%  { transform: scale(1.08); }
  85%  { transform: scale(0.97); }
  100% { transform: scale(1); opacity: 1; }
}
@keyframes stickerRemove {
  0% { transform: scale(1); opacity: 1; }
  100% { transform: scale(0); opacity: 0; }
}
@keyframes stickerSlideOut {
  0% { transform: translateX(0); opacity: 1; }
  100% { transform: translateX(80px); opacity: 0; }
}

/* Particle */
.particle {
  position: absolute;
  width: 6px; height: 6px;
  border-radius: 50%;
  pointer-events: none;
  z-index: 5;
}

/* ‚îÄ‚îÄ Gantt page ‚îÄ‚îÄ */
.gantt-section-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
  text-align: center;
}
.gantt-legend {
  display: flex;
  gap: 16px;
  justify-content: center;
  margin-bottom: 10px;
  font-size: 11px;
  color: var(--text-light);
}
.gantt-legend span {
  display: flex;
  align-items: center;
  gap: 4px;
}
.legend-swatch {
  display: inline-block;
  width: 12px; height: 12px;
  border-radius: 3px;
}
.legend-swatch.plan { background: var(--text-light); opacity: 0.4; }
.legend-swatch.forecast-combined {
  background: repeating-linear-gradient(
    -45deg,
    rgba(130, 184, 154, 0.5),
    rgba(130, 184, 154, 0.5) 2px,
    transparent 2px,
    transparent 4px
  );
  border: 1px dashed #82b89a;
}

.gantt-chart {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 16px 12px;
  box-shadow: 0 2px 8px var(--shadow);
  position: relative;
}

/* Date axis */
.gantt-date-axis {
  display: flex;
  margin-left: 50px;
  margin-bottom: 6px;
  position: relative;
  height: 18px;
}
.gantt-date-tick {
  position: absolute;
  font-size: 9px;
  color: var(--text-light);
  transform: translateX(-50%);
  white-space: nowrap;
  top: 0;
}

/* Timeline area (rows + vertical lines) */
.gantt-timeline {
  position: relative;
  margin-left: 50px;
}

.gantt-row {
  display: flex;
  align-items: center;
  margin-bottom: 6px;
  position: relative;
  height: 36px;
}
.gantt-label {
  position: absolute;
  left: -50px;
  width: 46px;
  font-size: 11px;
  font-weight: 500;
  text-align: right;
}
.gantt-bar-track {
  width: 100%;
  height: 36px;
  position: relative;
  background: #f5f3f0;
  border-radius: 8px;
  overflow: visible;
}

/* Plan bar */
.gantt-plan-bar {
  position: absolute;
  height: 100%;
  border-radius: 8px;
  opacity: 0.25;
  top: 0;
}

/* Actual progress bar */
.gantt-actual-bar {
  position: absolute;
  height: 100%;
  border-radius: 8px;
  top: 0;
  transition: width 0.4s ease;
}
.gantt-actual-label {
  position: absolute;
  right: 4px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 9px;
  font-weight: 600;
  color: #fff;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  white-space: nowrap;
}

/* Forecast overlay */
.gantt-forecast-bar {
  position: absolute;
  height: 100%;
  border-radius: 8px;
  top: 0;
  opacity: 0.35;
  transition: width 0.4s ease, left 0.4s ease;
}
.gantt-forecast-bar.late {
  background: repeating-linear-gradient(
    -45deg,
    transparent,
    transparent 3px,
    rgba(224, 112, 112, 0.3) 3px,
    rgba(224, 112, 112, 0.3) 6px
  );
  border: 2px dashed #e07070;
}
.gantt-forecast-bar.on-track {
  background: repeating-linear-gradient(
    -45deg,
    transparent,
    transparent 3px,
    rgba(130, 184, 154, 0.3) 3px,
    rgba(130, 184, 154, 0.3) 6px
  );
  border: 2px dashed #82b89a;
}

/* Drag handle between processes */
.gantt-drag-handle {
  position: absolute;
  top: 0;
  width: 14px;
  height: 100%;
  cursor: col-resize;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
  transform: translateX(-50%);
}
.gantt-drag-handle::after {
  content: '';
  width: 4px;
  height: 20px;
  border-radius: 2px;
  background: rgba(74,74,74,0.3);
  transition: background 0.2s, height 0.2s;
}
.gantt-drag-handle:hover::after,
.gantt-drag-handle.dragging::after {
  background: rgba(74,74,74,0.6);
  height: 28px;
}

/* Vertical lines */
.gantt-vline {
  position: absolute;
  top: -24px;
  width: 2px;
  z-index: 5;
  pointer-events: none;
}
.gantt-vline.today-line { background: var(--today-line); }
.gantt-vline.deadline-line {
  background: var(--deadline-line);
  border-left: 1px dashed var(--deadline-line);
  width: 1px;
}
.gantt-vline-label {
  position: absolute;
  top: -2px;
  font-size: 8px;
  white-space: nowrap;
  transform: translateX(-50%);
  left: 50%;
}
.gantt-vline.today-line .gantt-vline-label { color: var(--today-line); }
.gantt-vline.deadline-line .gantt-vline-label { color: var(--deadline-line); }

/* Connected plan bar */
.gantt-connected-bar {
  position: relative;
  height: 36px;
  margin-bottom: 12px;
  border-radius: 8px;
  overflow: visible;
  display: flex;
}
.gantt-connected-segment {
  height: 100%;
  position: relative;
  transition: flex 0.2s ease;
}
.gantt-connected-segment:first-child { border-radius: 8px 0 0 8px; }
.gantt-connected-segment:last-child { border-radius: 0 8px 8px 0; }
.gantt-connected-segment-label {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 10px;
  font-weight: 600;
  color: #fff;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  white-space: nowrap;
  pointer-events: none;
}

.gantt-info {
  margin-top: 12px;
  padding: 10px 14px;
  background: var(--name-bg);
  border-radius: 12px;
  font-size: 13px;
  line-height: 1.5;
  color: #806068;
  text-align: center;
}

/* ‚îÄ‚îÄ Pace Analysis ‚îÄ‚îÄ */
.pace-analysis {
  margin-top: 12px;
  background: var(--card-bg);
  border-radius: 16px;
  padding: 14px;
  box-shadow: 0 2px 8px var(--shadow);
}
.pace-analysis-title {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text);
}
.pace-process {
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
  line-height: 1.6;
}
.pace-process:last-child { border-bottom: none; }
.pace-process-name {
  font-weight: 600;
}
.pace-process-detail {
  color: var(--text-light);
  font-size: 11px;
  padding-left: 8px;
}
.pace-summary {
  margin-top: 8px;
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
}
.pace-summary.over { background: #fdf0f0; color: #c04040; }
.pace-summary.ok { background: #eef7f2; color: #508068; }

/* ‚îÄ‚îÄ Calendar page ‚îÄ‚îÄ */
.calendar-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  margin-bottom: 10px;
}
.cal-nav-btn {
  background: none;
  border: none;
  font-size: 16px;
  cursor: pointer;
  color: var(--text);
  padding: 4px 8px;
}
.cal-month-label {
  font-size: 16px;
  font-weight: 600;
}
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}
.cal-weekday-header {
  text-align: center;
  font-size: 10px;
  color: var(--text-light);
  padding: 4px 0;
}
.cal-day {
  min-height: 44px;
  background: var(--card-bg);
  border-radius: 8px;
  padding: 4px;
  text-align: center;
  cursor: pointer;
  position: relative;
}
.cal-day.today {
  border: 2px solid var(--name-color);
}
.cal-day.other-month {
  opacity: 0.3;
}
.cal-day.selected {
  background: var(--name-bg);
}
.cal-day-num {
  font-size: 11px;
  font-weight: 500;
}
.cal-day-dots {
  display: flex;
  justify-content: center;
  gap: 2px;
  margin-top: 2px;
  flex-wrap: wrap;
}
.cal-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
}
.calendar-detail {
  margin-top: 12px;
  background: var(--card-bg);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 2px 8px var(--shadow);
  min-height: 60px;
}
.cal-detail-title {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 8px;
}
.cal-detail-item {
  font-size: 12px;
  padding: 3px 0;
  display: flex;
  align-items: center;
  gap: 6px;
}
.cal-detail-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.cal-detail-empty {
  font-size: 12px;
  color: var(--text-light);
  text-align: center;
  padding: 10px 0;
}

/* ‚îÄ‚îÄ Settings page ‚îÄ‚îÄ */
.settings-card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 2px 8px var(--shadow);
  margin-bottom: 16px;
}
.settings-card h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text);
}
.setting-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}
.setting-row:last-child { border-bottom: none; }
.setting-label { color: var(--text); }
.setting-value {
  color: var(--text-light);
  font-weight: 500;
  text-align: right;
}
.setting-value input {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 4px 8px;
  font-size: 13px;
  width: 120px;
  text-align: right;
  color: var(--text);
  background: var(--bg);
}
.process-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.process-item {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
}
.process-dot {
  width: 14px; height: 14px;
  border-radius: 50%;
  flex-shrink: 0;
}
.setting-task-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}
.setting-task-row:last-child { border-bottom: none; }
.setting-task-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}
.setting-task-info {
  flex: 1;
}
.setting-task-meta {
  font-size: 11px;
  color: var(--text-light);
}

/* ‚îÄ‚îÄ Task edit UI ‚îÄ‚îÄ */
.task-edit-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}
.task-edit-row:last-child { border-bottom: none; }
.task-edit-colors {
  display: flex;
  gap: 4px;
}
.task-color-btn {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid transparent;
  cursor: pointer;
  transition: border-color 0.2s;
}
.task-color-btn.selected {
  border-color: var(--text);
}
.task-edit-input {
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 3px 6px;
  font-size: 12px;
  color: var(--text);
  background: var(--bg);
}
.task-edit-input-name { width: 70px; }
.task-edit-input-count { width: 36px; text-align: center; }
.task-edit-input-date { width: 110px; }
.task-delete-btn {
  background: none;
  border: none;
  color: var(--text-light);
  cursor: pointer;
  font-size: 16px;
  padding: 2px 4px;
  line-height: 1;
  transition: color 0.2s;
}
.task-delete-btn:hover { color: #e07070; }
.task-add-btn {
  display: block;
  width: 100%;
  margin-top: 8px;
  padding: 8px;
  border: 2px dashed var(--border);
  border-radius: 10px;
  background: none;
  color: var(--text-light);
  font-size: 13px;
  cursor: pointer;
  transition: border-color 0.2s, color 0.2s;
}
.task-add-btn:hover {
  border-color: var(--text-light);
  color: var(--text);
}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
.toast {
  position: absolute;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: rgba(74,74,74,0.9);
  color: #fff;
  font-size: 12px;
  padding: 8px 16px;
  border-radius: 20px;
  opacity: 0;
  transition: all 0.3s;
  pointer-events: none;
  z-index: 10;
  white-space: nowrap;
}
.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

@media (max-width: 420px) {
  .phone-frame {
    width: 100%;
    height: 100dvh;
    border-radius: 0;
    box-shadow: none;
  }
  .workmate-area iframe { height: 600px; border-radius: 12px; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê Âêå‰∫∫„Çè„Çì„Åü„Å£„Å∑ „Ç®„É™„Ç¢ ‚ïê‚ïê -->
<div class="app-section wantap-area">
  <div class="app-header">
    <div class="app-title">Âêå‰∫∫„Çè„Çì„Åü„Å£„Å∑</div>
    <div class="app-tagline">‰ΩúÊ•≠„ÅåÈÄ≤„Çì„Å†„Çâ„ÄÅ„Çø„ÉÉ„Éó„Åô„Çã„Å†„Åë„ÄÇ<br>„ÉØ„É≥„Çø„ÉÉ„Éó„ÅßÈÄ≤ÊçóÁÆ°ÁêÜ„ÄÇ</div>
  </div>

<div class="phone-frame">
  <div class="header">
    <h1>
      <svg class="header-dog-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Ears -->
        <ellipse cx="22" cy="30" rx="16" ry="24" fill="#d4a574" transform="rotate(-15 22 30)"/>
        <ellipse cx="78" cy="30" rx="16" ry="24" fill="#d4a574" transform="rotate(15 78 30)"/>
        <ellipse cx="23" cy="32" rx="10" ry="17" fill="#e8c4a0" transform="rotate(-15 23 32)"/>
        <ellipse cx="77" cy="32" rx="10" ry="17" fill="#e8c4a0" transform="rotate(15 77 32)"/>
        <!-- Face -->
        <ellipse cx="50" cy="55" rx="32" ry="30" fill="#e8c4a0"/>
        <!-- Eyes -->
        <ellipse cx="38" cy="48" rx="4" ry="4.5" fill="#4a4a4a"/>
        <ellipse cx="62" cy="48" rx="4" ry="4.5" fill="#4a4a4a"/>
        <ellipse cx="39.5" cy="46.5" rx="1.5" ry="1.5" fill="#fff"/>
        <ellipse cx="63.5" cy="46.5" rx="1.5" ry="1.5" fill="#fff"/>
        <!-- Nose -->
        <ellipse cx="50" cy="60" rx="6" ry="4.5" fill="#4a4a4a"/>
        <ellipse cx="50" cy="59" rx="2" ry="1.2" fill="#7a7a7a"/>
        <!-- Mouth -->
        <path d="M44 64 Q50 70 56 64" stroke="#4a4a4a" stroke-width="1.8" fill="none" stroke-linecap="round"/>
        <!-- Cheeks -->
        <ellipse cx="30" cy="58" rx="6" ry="4" fill="#f0b0a0" opacity="0.35"/>
        <ellipse cx="70" cy="58" rx="6" ry="4" fill="#f0b0a0" opacity="0.35"/>
      </svg>
      Âêå‰∫∫„Çè„Çì„Åü„Å£„Å∑
    </h1>
  </div>

  <div class="nav-labels">
    <div class="nav-label" data-page="0">„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà</div>
    <div class="nav-label active" data-page="1">‰ªäÊó•„ÅÆÈÄ≤Êçó</div>
    <div class="nav-label" data-page="2">„Ç´„É¨„É≥„ÉÄ„Éº</div>
    <div class="nav-label" data-page="3">Ë®≠ÂÆö</div>
  </div>

  <div class="nav-dots">
    <div class="nav-dot" data-page="0"></div>
    <div class="nav-dot active" data-page="1"></div>
    <div class="nav-dot" data-page="2"></div>
    <div class="nav-dot" data-page="3"></div>
  </div>

  <div class="swipe-container">
    <div class="swipe-track" id="swipeTrack">

      <!-- „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà -->
      <div class="page" id="pageGantt">
        <div class="gantt-section-title">„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà</div>
        <div class="gantt-legend">
          <span><span class="legend-swatch plan"></span>Ë®àÁîª</span>
          <span><span class="legend-swatch forecast-combined"></span>ÊÉ≥ÂÆö</span>
        </div>
        <div class="gantt-chart" id="ganttChart"></div>
        <div class="gantt-info" id="ganttInfo"></div>
        <div id="paceAnalysis"></div>
      </div>

      <!-- ‰ªäÊó•„ÅÆÈÄ≤Êçó -->
      <div class="page" id="pageToday">
        <div class="date-display">
          <div class="date" id="todayDate"></div>
          <div class="weekday" id="todayWeekday"></div>
        </div>
        <div class="daily-event-row" id="dailyEventRow"></div>
        <div class="tap-grid" id="tapGrid"></div>
      </div>

      <!-- „Ç´„É¨„É≥„ÉÄ„Éº -->
      <div class="page" id="pageCalendar">
        <div class="calendar-header">
          <button class="cal-nav-btn" id="calPrev">‚óÄ</button>
          <span class="cal-month-label" id="calMonthLabel"></span>
          <button class="cal-nav-btn" id="calNext">‚ñ∂</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
        <div class="calendar-detail" id="calendarDetail"></div>
      </div>

      <!-- Ë®≠ÂÆö -->
      <div class="page" id="pageSettings">
        <div class="settings-card">
          <h3>„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±</h3>
          <div class="setting-row">
            <span class="setting-label">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç</span>
            <span class="setting-value"><input type="text" id="projName" value="Â§è„Ç≥„ÉüÊñ∞Âàä"></span>
          </div>
          <div class="setting-row">
            <span class="setting-label">Á∑è„Éö„Éº„Ç∏Êï∞</span>
            <span class="setting-value"><input type="number" id="projPages" value="16" min="1" max="999"></span>
          </div>
          <div class="setting-row">
            <span class="setting-label">ÈñãÂßãÊó•</span>
            <span class="setting-value"><input type="date" id="projStart" value="2026-02-20"></span>
          </div>
          <div class="setting-row">
            <span class="setting-label">Á∑†ÂàáÊó•</span>
            <span class="setting-value"><input type="date" id="projDeadline" value="2026-04-15"></span>
          </div>
        </div>
        <div class="settings-card">
          <h3>Â∑•Á®ã</h3>
          <div class="process-list">
            <div class="process-item">
              <div class="process-dot" style="background:var(--name-color)"></div>
              <span>„Éç„Éº„É†</span>
            </div>
            <div class="process-item">
              <div class="process-dot" style="background:var(--draft-color)"></div>
              <span>‰∏ãÊõ∏„Åç</span>
            </div>
            <div class="process-item">
              <div class="process-dot" style="background:var(--ink-color)"></div>
              <span>„Éö„É≥ÂÖ•„Çå</span>
            </div>
            <div class="process-item">
              <div class="process-dot" style="background:var(--finish-color)"></div>
              <span>‰ªï‰∏ä„Åí</span>
            </div>
          </div>
        </div>
        <div class="settings-card" id="settingsDailyCard">
          <h3>„Éá„Ç§„É™„Éº„Çø„Çπ„ÇØ</h3>
          <div id="settingsDailyList"></div>
        </div>
        <div class="settings-card" id="settingsEventCard">
          <h3>„Ç§„Éô„É≥„Éà„Çø„Çπ„ÇØ</h3>
          <div id="settingsEventList"></div>
        </div>
        <div class="settings-card">
          <h3>„Åì„ÅÆ„Éá„É¢„Å´„Å§„ÅÑ„Å¶</h3>
          <p style="font-size:12px;color:var(--text-light);line-height:1.6;">
            „Ç∑„Éº„É´ÂºèÈÄ≤ÊçóÁÆ°ÁêÜ„ÅÆ„Ç≥„É≥„Çª„Éó„Éà„Éá„É¢ v5„Åß„Åô„ÄÇÂêÑ„Ç®„É™„Ç¢„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Ç∑„Éº„É´„ÇíË≤º„Çä„ÄÅÊ®™„Çπ„ÉØ„Ç§„Éó„ÅßÂâ•„Åå„Åõ„Åæ„Åô„ÄÇ„Éá„Éº„Çø„ÅØ„Éö„Éº„Ç∏ÂÜÖ„ÅÆ„Åø„Å´‰øùÊåÅ„Åï„Çå„Åæ„Åô„ÄÇ
          </p>
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
// ‚îÄ‚îÄ Process definitions ‚îÄ‚îÄ
const PROCESSES = [
  { id: 'name', label: '„Éç„Éº„É†', icon: '‚úèÔ∏è', cls: 'name', stickerCls: 'name-s', cellCls: 'name-cell', color: '#e8a0b4' },
  { id: 'draft', label: '‰∏ãÊõ∏„Åç', icon: 'üìù', cls: 'draft', stickerCls: 'draft-s', cellCls: 'draft-cell', color: '#e8b472' },
  { id: 'ink', label: '„Éö„É≥ÂÖ•„Çå', icon: 'üñäÔ∏è', cls: 'ink', stickerCls: 'ink-s', cellCls: 'ink-cell', color: '#7baed4' },
  { id: 'finish', label: '‰ªï‰∏ä„Åí', icon: '‚ú®', cls: 'finish', stickerCls: 'finish-s', cellCls: 'finish-cell', color: '#82b89a' },
];

// ‚îÄ‚îÄ Daily / Event task definitions (mutable for editing) ‚îÄ‚îÄ
const today = new Date();
const todayStr = today.toISOString().slice(0, 10);

const TASK_COLORS = ['#c4a6d4', '#d4a6b8', '#d4b896', '#a6c4b8', '#a6b8d4'];
let nextTaskId = 100;

let DAILY_TASKS = [
  { id: 'stretch', label: '„Çπ„Éà„É¨„ÉÉ„ÉÅ', count: 1, color: '#c4a6d4' },
  { id: 'practice', label: 'Á∑¥Áøí', count: 2, color: '#d4a6b8' },
];

let EVENT_TASKS = [
  { id: 'evt1', label: 'Áî≥ËæºÁ∑†Âàá', date: todayStr, color: '#d4b896' },
];

// ‚îÄ‚îÄ Sample sticker log (historical data for demo) ‚îÄ‚îÄ
const stickerLog = [
  { process: 'name', date: '2026-02-20', count: 2 },
  { process: 'name', date: '2026-02-21', count: 2 },
  { process: 'name', date: '2026-02-22', count: 1 },
  { process: 'name', date: '2026-02-24', count: 1 },
  { process: 'name', date: '2026-02-25', count: 1 },
  { process: 'draft', date: '2026-02-23', count: 1 },
  { process: 'draft', date: '2026-02-25', count: 1 },
  { process: 'draft', date: '2026-02-26', count: 1 },
];

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
const state = {
  currentPage: 1,
  totalPages: 16,
  stickers: [], // today's stickers: { process, x, y, timestamp }
  planRatios: [0.25, 0.25, 0.25, 0.25],
  dailyDone: {},   // { 'stretch': 0, 'practice': 0 }
  eventDone: {},   // { 'evt1': false }
  calYear: today.getFullYear(),
  calMonth: today.getMonth(),
  calSelectedDate: todayStr,
};

// Initialize daily/event state
DAILY_TASKS.forEach(t => { state.dailyDone[t.id] = 0; });
EVENT_TASKS.forEach(t => { state.eventDone[t.id] = false; });

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function parseDate(str) {
  const [y, m, d] = str.split('-').map(Number);
  return new Date(y, m - 1, d);
}

function daysBetween(d1, d2) {
  return Math.round((d2 - d1) / 86400000);
}

function formatDateStr(y, m, d) {
  return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
}

function getHistoryCount(processId) {
  return stickerLog
    .filter(e => e.process === processId)
    .reduce((sum, e) => sum + e.count, 0);
}

function getTodayCount(processId) {
  return state.stickers.filter(s => s.process === processId).length;
}

function getTotal(processId) {
  return getHistoryCount(processId) + getTodayCount(processId);
}

// ‚îÄ‚îÄ Paw SVG helper ‚îÄ‚îÄ
function pawSVG(color, withGloss) {
  const gloss = withGloss
    ? `<ellipse cx="50" cy="58" rx="14" ry="8" fill="white" opacity="0.25"/>
       <ellipse cx="28" cy="30" rx="5" ry="4" fill="white" opacity="0.2"/>
       <ellipse cx="42" cy="24" rx="5" ry="4" fill="white" opacity="0.2"/>`
    : '';
  return `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="pg_${color.replace('#','')}" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${color}" stop-opacity="1"/>
        <stop offset="100%" stop-color="${color}" stop-opacity="0.65"/>
      </linearGradient>
    </defs>
    <ellipse cx="50" cy="68" rx="22" ry="20" fill="url(#pg_${color.replace('#','')})"/>
    <ellipse cx="28" cy="38" rx="10" ry="11" fill="url(#pg_${color.replace('#','')})"/>
    <ellipse cx="50" cy="30" rx="10" ry="11" fill="url(#pg_${color.replace('#','')})"/>
    <ellipse cx="72" cy="38" rx="10" ry="11" fill="url(#pg_${color.replace('#','')})"/>
    ${gloss}
  </svg>`;
}

function pawOutlineSVG(color) {
  return `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <ellipse cx="50" cy="68" rx="22" ry="20" fill="none" stroke="${color}" stroke-width="2.5" opacity="0.5"/>
    <ellipse cx="28" cy="38" rx="10" ry="11" fill="none" stroke="${color}" stroke-width="2.5" opacity="0.5"/>
    <ellipse cx="50" cy="30" rx="10" ry="11" fill="none" stroke="${color}" stroke-width="2.5" opacity="0.5"/>
    <ellipse cx="72" cy="38" rx="10" ry="11" fill="none" stroke="${color}" stroke-width="2.5" opacity="0.5"/>
  </svg>`;
}

// ‚îÄ‚îÄ Pace calculation ‚îÄ‚îÄ
function calcPace(processId) {
  const startStr = document.getElementById('projStart').value;
  const projStart = parseDate(startStr);

  const logEntries = stickerLog.filter(e => e.process === processId);
  const todayCount = getTodayCount(processId);

  const dateMap = {};
  logEntries.forEach(e => { dateMap[e.date] = (dateMap[e.date] || 0) + e.count; });
  if (todayCount > 0) {
    dateMap[todayStr] = (dateMap[todayStr] || 0) + todayCount;
  }

  const dates = Object.keys(dateMap).sort();
  if (dates.length === 0) return null;

  const totalStickers = Object.values(dateMap).reduce((a, b) => a + b, 0);
  if (totalStickers <= 1) return null;

  const firstDate = parseDate(dates[0]);
  const lastDate = parseDate(dates[dates.length - 1]);

  let periodStart;
  if (processId === 'name') {
    periodStart = projStart;
  } else {
    periodStart = firstDate;
  }

  const days = Math.max(1, daysBetween(periodStart, lastDate) + 1);
  const pace = totalStickers / days;

  return { pace, totalStickers, firstDate, lastDate, periodStart, days };
}

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
const swipeTrack = document.getElementById('swipeTrack');
const navDots = document.querySelectorAll('.nav-dot');
const navLabels = document.querySelectorAll('.nav-label');

function goToPage(idx) {
  state.currentPage = idx;
  swipeTrack.style.transform = `translateX(-${idx * 25}%)`;
  navDots.forEach((d, i) => d.classList.toggle('active', i === idx));
  navLabels.forEach((l, i) => l.classList.toggle('active', i === idx));
  if (idx === 0) renderGantt();
  if (idx === 2) renderCalendar();
}

navDots.forEach(d => d.addEventListener('click', () => goToPage(+d.dataset.page)));
navLabels.forEach(l => l.addEventListener('click', () => goToPage(+l.dataset.page)));

// Swipe (touch)
let touchStartX = 0, touchStartY = 0, swiping = false;
const swipeContainer = document.querySelector('.swipe-container');

swipeContainer.addEventListener('touchstart', e => {
  touchStartX = e.touches[0].clientX;
  touchStartY = e.touches[0].clientY;
  swiping = true;
}, { passive: true });

swipeContainer.addEventListener('touchend', e => {
  if (!swiping) return;
  swiping = false;
  const dx = e.changedTouches[0].clientX - touchStartX;
  const dy = e.changedTouches[0].clientY - touchStartY;
  if (Math.abs(dx) < 50 || Math.abs(dy) > Math.abs(dx)) return;
  if (dx < 0 && state.currentPage < 3) goToPage(state.currentPage + 1);
  if (dx > 0 && state.currentPage > 0) goToPage(state.currentPage - 1);
}, { passive: true });

// Swipe (mouse - page navigation)
let mouseDown = false, mouseStartX = 0;
swipeContainer.addEventListener('mousedown', e => { mouseDown = true; mouseStartX = e.clientX; });
swipeContainer.addEventListener('mouseup', e => {
  if (!mouseDown) return;
  mouseDown = false;
  const dx = e.clientX - mouseStartX;
  if (Math.abs(dx) < 50) return;
  if (dx < 0 && state.currentPage < 3) goToPage(state.currentPage + 1);
  if (dx > 0 && state.currentPage > 0) goToPage(state.currentPage - 1);
});

// ‚îÄ‚îÄ Date display ‚îÄ‚îÄ
const WEEKDAYS = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
document.getElementById('todayDate').textContent = `${today.getMonth() + 1}Êúà${today.getDate()}Êó•`;
document.getElementById('todayWeekday').textContent = `${WEEKDAYS[today.getDay()]}ÊõúÊó•`;

// ‚îÄ‚îÄ Daily / Event row (Â§âÊõ¥2: „Çπ„É≠„ÉÉ„ÉàÂÄãÂà•„ÇØ„É™„ÉÉ„ÇØ) ‚îÄ‚îÄ
function renderDailyEventRow() {
  const row = document.getElementById('dailyEventRow');
  row.innerHTML = '';

  // Daily tasks
  DAILY_TASKS.forEach(task => {
    const card = document.createElement('div');
    card.className = 'de-card';

    const label = document.createElement('span');
    label.className = 'de-card-label';
    label.style.color = task.color;
    label.textContent = task.label;
    card.appendChild(label);

    const slots = document.createElement('div');
    slots.className = 'de-card-slots';

    for (let i = 0; i < task.count; i++) {
      const slot = document.createElement('div');
      slot.className = 'de-paw-slot';
      slot.dataset.taskId = task.id;
      slot.dataset.slotIndex = i;

      if (i < state.dailyDone[task.id]) {
        slot.classList.add('done');
        slot.innerHTML = `<span class="paw-filled">${pawSVG(task.color, true)}</span>`;
      } else {
        slot.innerHTML = `<span class="paw-outline">${pawOutlineSVG(task.color)}</span>`;
      }

      // Individual slot click
      slot.addEventListener('click', (e) => {
        e.stopPropagation();
        const isDone = i < state.dailyDone[task.id];
        if (isDone) {
          // Undo this slot: set done count to this index
          state.dailyDone[task.id] = i;
          if (navigator.vibrate) navigator.vibrate(10);
          renderDailyEventRow();
        } else {
          // Fill up to and including this slot
          state.dailyDone[task.id] = i + 1;
          if (navigator.vibrate) navigator.vibrate(15);
          renderDailyEventRow();
          // Bounce the newly filled slot
          const newSlots = row.querySelectorAll(`.de-paw-slot[data-task-id="${task.id}"]`);
          const filledSlot = newSlots[i];
          if (filledSlot) filledSlot.classList.add('bounce');
        }
      });

      slots.appendChild(slot);
    }

    card.appendChild(slots);
    row.appendChild(card);
  });

  // Event tasks (today only)
  EVENT_TASKS.filter(t => t.date === todayStr).forEach(task => {
    const card = document.createElement('div');
    card.className = 'de-card';

    const label = document.createElement('span');
    label.className = 'de-card-label';
    label.style.color = task.color;
    label.textContent = task.label;
    card.appendChild(label);

    const slots = document.createElement('div');
    slots.className = 'de-card-slots';

    const slot = document.createElement('div');
    slot.className = 'de-paw-slot';
    if (state.eventDone[task.id]) {
      slot.classList.add('done');
      slot.innerHTML = `<span class="paw-filled">${pawSVG(task.color, true)}</span>`;
    } else {
      slot.innerHTML = `<span class="paw-outline">${pawOutlineSVG(task.color)}</span>`;
    }

    // Individual slot click for toggle
    slot.addEventListener('click', (e) => {
      e.stopPropagation();
      if (state.eventDone[task.id]) {
        // Undo
        state.eventDone[task.id] = false;
        if (navigator.vibrate) navigator.vibrate(10);
        renderDailyEventRow();
      } else {
        // Complete
        state.eventDone[task.id] = true;
        if (navigator.vibrate) navigator.vibrate(15);
        renderDailyEventRow();
        const newSlot = row.querySelector(`.de-paw-slot.done`);
        if (newSlot) newSlot.classList.add('bounce');
      }
    });

    slots.appendChild(slot);
    card.appendChild(slots);
    row.appendChild(card);
  });
}

// ‚îÄ‚îÄ Grid layout calculation ‚îÄ‚îÄ
function getPlannedProcessIndex() {
  const startStr = document.getElementById('projStart').value;
  const deadlineStr = document.getElementById('projDeadline').value;
  const projStart = parseDate(startStr);
  const deadline = parseDate(deadlineStr);
  const totalDays = daysBetween(projStart, deadline);
  if (totalDays <= 0) return 0;
  const todayOffset = daysBetween(projStart, today);
  const todayFrac = todayOffset / totalDays;

  let cumulative = 0;
  for (let i = 0; i < PROCESSES.length; i++) {
    cumulative += state.planRatios[i];
    if (todayFrac < cumulative) return i;
  }
  return PROCESSES.length - 1;
}

function calcGridLayout() {
  let mainIdx = getPlannedProcessIndex();

  if (getTotal(PROCESSES[mainIdx].id) >= state.totalPages) {
    let found = false;
    for (let i = mainIdx + 1; i < PROCESSES.length; i++) {
      if (getTotal(PROCESSES[i].id) < state.totalPages) {
        mainIdx = i;
        found = true;
        break;
      }
    }
    if (!found) {
      for (let i = 0; i < mainIdx; i++) {
        if (getTotal(PROCESSES[i].id) < state.totalPages) {
          mainIdx = i;
          break;
        }
      }
    }
  }

  let nextIdx = -1;
  for (let i = mainIdx + 1; i < PROCESSES.length; i++) {
    if (getTotal(PROCESSES[i].id) < state.totalPages) {
      nextIdx = i;
      break;
    }
  }

  const restIndices = [];
  for (let i = 0; i < PROCESSES.length; i++) {
    if (i !== mainIdx && i !== nextIdx) {
      restIndices.push(i);
    }
  }

  const mainDone = getTotal(PROCESSES[mainIdx].id);
  const mainProgress = mainDone / state.totalPages;
  const transition = Math.max(0, Math.min(1, (mainProgress - 0.6) / 0.4));

  const lerp = (a, b, t) => a + (b - a) * t;
  const topRatio = lerp(55, 30, transition);
  const bottomRatio = 100 - topRatio;
  const leftPct = lerp(50, 65, transition);

  return { mainIdx, nextIdx, restIndices, topRatio, bottomRatio, leftPct };
}

function updateGridLayout() {
  const grid = document.getElementById('tapGrid');
  const layout = calcGridLayout();

  grid.style.setProperty('--top-ratio', `${layout.topRatio}fr`);
  grid.style.setProperty('--bottom-ratio', `${layout.bottomRatio}fr`);
  grid.style.setProperty('--left-ratio', `${layout.leftPct}fr`);
  grid.style.setProperty('--right-ratio', `${100 - layout.leftPct}fr`);
}

// ‚îÄ‚îÄ Variable Tap Grid ‚îÄ‚îÄ
function createTapGrid() {
  const grid = document.getElementById('tapGrid');
  grid.innerHTML = '';

  const layout = calcGridLayout();

  grid.style.setProperty('--top-ratio', `${layout.topRatio}fr`);
  grid.style.setProperty('--bottom-ratio', `${layout.bottomRatio}fr`);
  grid.style.setProperty('--left-ratio', `${layout.leftPct}fr`);
  grid.style.setProperty('--right-ratio', `${100 - layout.leftPct}fr`);

  function createCell(p) {
    const cell = document.createElement('div');
    cell.className = `tap-cell ${p.cellCls}`;
    cell.dataset.process = p.id;

    const header = document.createElement('div');
    header.className = 'tap-cell-header';
    header.innerHTML = `<span class="icon">${p.icon}</span><span>${p.label}</span><span class="progress">${getTotal(p.id)}/${state.totalPages}</span>`;
    cell.appendChild(header);

    const stickersArea = document.createElement('div');
    stickersArea.className = 'tap-cell-stickers';
    stickersArea.dataset.process = p.id;
    cell.appendChild(stickersArea);

    cell.addEventListener('click', (e) => {
      if (e.target.closest('.sticker')) return;
      const rect = stickersArea.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;
      addSticker(p.id, x, y);
    });

    return cell;
  }

  const mainCell = createCell(PROCESSES[layout.mainIdx]);
  mainCell.classList.add('tap-cell-main');
  grid.appendChild(mainCell);

  if (layout.nextIdx >= 0) {
    const nextCell = createCell(PROCESSES[layout.nextIdx]);
    nextCell.classList.add('tap-cell-next');
    grid.appendChild(nextCell);
  }

  if (layout.restIndices.length > 0) {
    const restWrap = document.createElement('div');
    restWrap.className = 'tap-cell-rest-wrap';
    layout.restIndices.forEach(idx => {
      restWrap.appendChild(createCell(PROCESSES[idx]));
    });
    grid.appendChild(restWrap);
  }
}

function updateCellHeaders() {
  PROCESSES.forEach(p => {
    const cell = document.querySelector(`.tap-cell[data-process="${p.id}"]`);
    if (!cell) return;
    const progress = cell.querySelector('.tap-cell-header .progress');
    if (progress) {
      progress.textContent = `${getTotal(p.id)}/${state.totalPages}`;
    }
  });
}

// ‚îÄ‚îÄ Particles ‚îÄ‚îÄ
function emitParticles(containerEl, x, y, color) {
  const count = 4 + Math.floor(Math.random() * 2);
  for (let i = 0; i < count; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.style.background = color;
    particle.style.left = x + 'px';
    particle.style.top = y + 'px';
    particle.style.position = 'absolute';

    const angle = (Math.PI * 2 / count) * i + (Math.random() - 0.5) * 0.5;
    const dist = 15 + Math.random() * 15;
    const tx = Math.cos(angle) * dist;
    const ty = Math.sin(angle) * dist;
    particle.style.width = (4 + Math.random() * 3) + 'px';
    particle.style.height = particle.style.width;

    containerEl.appendChild(particle);

    requestAnimationFrame(() => {
      particle.style.transition = 'transform 0.45s ease-out, opacity 0.45s ease-out';
      particle.style.transform = `translate(${tx}px, ${ty}px) scale(0.3)`;
      particle.style.opacity = '0';
    });

    setTimeout(() => particle.remove(), 500);
  }
}

// ‚îÄ‚îÄ Stickers ‚îÄ‚îÄ
function addSticker(processId, xPct, yPct) {
  const total = getTotal(processId);
  if (total >= state.totalPages) {
    showToast(`${PROCESSES.find(p => p.id === processId).label}„ÅØÂÖ®„Éö„Éº„Ç∏ÂÆå‰∫ÜÊ∏à„Åø„Åß„Åô`);
    return;
  }

  const offsetX = (Math.random() - 0.5) * 10;
  const offsetY = (Math.random() - 0.5) * 10;
  const finalX = Math.max(5, Math.min(85, xPct + offsetX));
  const finalY = Math.max(5, Math.min(85, yPct + offsetY));

  const prevLayout = calcGridLayout();

  state.stickers.push({ process: processId, x: finalX, y: finalY, timestamp: Date.now() });

  if (navigator.vibrate) navigator.vibrate(15);

  const newLayout = calcGridLayout();
  if (newLayout.mainIdx !== prevLayout.mainIdx) {
    createTapGrid();
    renderStickers();
  } else {
    updateGridLayout();
    renderStickers();
    updateCellHeaders();
  }
}

function removeSticker(processId, stickerIndex, slideOut) {
  const container = document.querySelector(`.tap-cell-stickers[data-process="${processId}"]`);
  if (!container) return;
  const stickers = container.querySelectorAll('.sticker');
  const el = stickers[stickerIndex];
  if (el) {
    el.classList.add(slideOut ? 'removing' : 'removing-shrink');
    setTimeout(() => {
      const processStickers = state.stickers
        .map((s, i) => ({ ...s, idx: i }))
        .filter(s => s.process === processId);
      const prevLayout = calcGridLayout();
      if (processStickers[stickerIndex]) {
        state.stickers.splice(processStickers[stickerIndex].idx, 1);
      }
      const newLayout = calcGridLayout();
      if (newLayout.mainIdx !== prevLayout.mainIdx) {
        createTapGrid();
        renderStickers();
      } else {
        updateGridLayout();
        renderStickers();
        updateCellHeaders();
      }
    }, 280);
  }
}

function renderStickers() {
  PROCESSES.forEach(p => {
    const container = document.querySelector(`.tap-cell-stickers[data-process="${p.id}"]`);
    if (!container) return;
    container.querySelectorAll('.sticker, .particle').forEach(el => el.remove());

    const processStickers = state.stickers.filter(s => s.process === p.id);
    processStickers.forEach((s, i) => {
      const el = document.createElement('div');
      el.className = `sticker`;
      el.innerHTML = pawSVG(p.color, true);
      el.style.left = `calc(${s.x}% - 20px)`;
      el.style.top = `calc(${s.y}% - 20px)`;

      setupStickerSwipe(el, p.id, i);

      container.appendChild(el);
    });

    if (processStickers.length > 0) {
      const newest = processStickers[processStickers.length - 1];
      const rect = container.getBoundingClientRect();
      if (newest.timestamp > Date.now() - 100) {
        const px = (newest.x / 100) * rect.width;
        const py = (newest.y / 100) * rect.height;
        emitParticles(container, px, py, p.color);
      }
    }
  });
}

// ‚îÄ‚îÄ Swipe-to-delete on stickers ‚îÄ‚îÄ
function setupStickerSwipe(el, processId, stickerIndex) {
  let startX = 0, startY = 0, isDragging = false, startTime = 0;
  let longPressTimer = null;

  function onStart(clientX, clientY, e) {
    startX = clientX;
    startY = clientY;
    isDragging = true;
    startTime = Date.now();
    longPressTimer = setTimeout(() => {
      if (isDragging) {
        isDragging = false;
        removeSticker(processId, stickerIndex, false);
      }
    }, 500);
  }

  function onMove(clientX, clientY) {
    if (!isDragging) return;
    const dx = clientX - startX;
    const dy = clientY - startY;
    if (Math.abs(dx) > 10) {
      el.style.transform = `translateX(${dx}px)`;
      el.style.opacity = Math.max(0.3, 1 - Math.abs(dx) / 100);
      clearTimeout(longPressTimer);
    }
  }

  function onEnd(clientX) {
    clearTimeout(longPressTimer);
    if (!isDragging) return;
    isDragging = false;
    const dx = clientX - startX;

    if (Math.abs(dx) >= 50) {
      removeSticker(processId, stickerIndex, true);
    } else {
      el.style.transform = '';
      el.style.opacity = '';
    }
  }

  el.addEventListener('touchstart', (e) => {
    e.stopPropagation();
    const t = e.touches[0];
    onStart(t.clientX, t.clientY, e);
  }, { passive: true });

  el.addEventListener('touchmove', (e) => {
    e.stopPropagation();
    const t = e.touches[0];
    onMove(t.clientX, t.clientY);
  }, { passive: true });

  el.addEventListener('touchend', (e) => {
    e.stopPropagation();
    const t = e.changedTouches[0];
    onEnd(t.clientX);
    e.preventDefault();
  });

  el.addEventListener('mousedown', (e) => {
    e.stopPropagation();
    e.preventDefault();
    onStart(e.clientX, e.clientY, e);

    const onMouseMove = (me) => onMove(me.clientX, me.clientY);
    const onMouseUp = (me) => {
      onEnd(me.clientX);
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    };
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  });

  el.addEventListener('click', (e) => {
    e.stopPropagation();
  });
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
let toastTimer;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2000);
}

// ‚îÄ‚îÄ Gantt chart ‚îÄ‚îÄ
function renderGantt() {
  const pages = parseInt(document.getElementById('projPages').value) || 16;
  state.totalPages = pages;

  const startStr = document.getElementById('projStart').value;
  const deadlineStr = document.getElementById('projDeadline').value;
  const projStart = parseDate(startStr);
  const deadline = parseDate(deadlineStr);
  const totalDays = Math.max(1, daysBetween(projStart, deadline));
  const todayOffset = daysBetween(projStart, today);

  const chart = document.getElementById('ganttChart');
  chart.innerHTML = '';

  const chartWidth = chart.clientWidth - 24;
  const barAreaWidth = chartWidth - 50;

  // ‚îÄ‚îÄ Date axis ‚îÄ‚îÄ
  const dateAxis = document.createElement('div');
  dateAxis.className = 'gantt-date-axis';
  dateAxis.style.width = barAreaWidth + 'px';

  const tickCount = 7;
  for (let i = 0; i < tickCount; i++) {
    const frac = i / (tickCount - 1);
    const d = new Date(projStart.getTime() + totalDays * frac * 86400000);
    const tick = document.createElement('div');
    tick.className = 'gantt-date-tick';
    tick.style.left = (frac * 100) + '%';
    tick.textContent = `${d.getMonth() + 1}/${d.getDate()}`;
    dateAxis.appendChild(tick);
  }
  chart.appendChild(dateAxis);

  // ‚îÄ‚îÄ Timeline container ‚îÄ‚îÄ
  const timeline = document.createElement('div');
  timeline.className = 'gantt-timeline';
  timeline.style.width = barAreaWidth + 'px';

  // ‚îÄ‚îÄ Connected plan bar ‚îÄ‚îÄ
  const connectedBar = document.createElement('div');
  connectedBar.className = 'gantt-connected-bar';
  connectedBar.style.width = '100%';

  PROCESSES.forEach((p, idx) => {
    const seg = document.createElement('div');
    seg.className = 'gantt-connected-segment';
    seg.style.flex = state.planRatios[idx];
    seg.style.background = p.color;
    seg.style.opacity = '0.5';

    const label = document.createElement('div');
    label.className = 'gantt-connected-segment-label';
    label.textContent = p.label;
    seg.appendChild(label);

    connectedBar.appendChild(seg);
  });

  for (let i = 0; i < 3; i++) {
    const handle = document.createElement('div');
    handle.className = 'gantt-drag-handle';
    handle.dataset.index = i;
    connectedBar.appendChild(handle);
    setupDragHandle(handle, i, connectedBar);
  }

  timeline.appendChild(connectedBar);
  requestAnimationFrame(() => positionDragHandles(connectedBar));

  // ‚îÄ‚îÄ Forecast data ‚îÄ‚îÄ
  const forecastData = [];
  let chainEndDayOffset = 0;

  PROCESSES.forEach((p, idx) => {
    const pace = calcPace(p.id);
    if (pace) {
      const forecastDays = pages / pace.pace;
      const startFrac = chainEndDayOffset / totalDays;
      const widthFrac = forecastDays / totalDays;
      forecastData.push({ startFrac, widthFrac, hasPace: true });
      chainEndDayOffset += forecastDays;
    } else {
      forecastData.push({ startFrac: 0, widthFrac: 0, hasPace: false });
    }
  });

  const noPaceIndices = forecastData
    .map((d, i) => d.hasPace ? -1 : i)
    .filter(i => i >= 0);

  if (noPaceIndices.length > 0) {
    let lastPaceEnd = 0;
    for (let i = 0; i < forecastData.length; i++) {
      if (forecastData[i].hasPace) {
        lastPaceEnd = forecastData[i].startFrac + forecastData[i].widthFrac;
      }
    }
    const remainingFrac = Math.max(0, 1 - lastPaceEnd);
    const eachFrac = noPaceIndices.length > 0 ? remainingFrac / noPaceIndices.length : 0;
    let cursor = lastPaceEnd;
    noPaceIndices.forEach(i => {
      forecastData[i].startFrac = cursor;
      forecastData[i].widthFrac = eachFrac;
      cursor += eachFrac;
    });
  }

  // ‚îÄ‚îÄ Process rows ‚îÄ‚îÄ
  PROCESSES.forEach((p, idx) => {
    const row = document.createElement('div');
    row.className = 'gantt-row';

    const label = document.createElement('div');
    label.className = 'gantt-label';
    label.textContent = p.label;
    row.appendChild(label);

    const track = document.createElement('div');
    track.className = 'gantt-bar-track';

    const planStartFrac = state.planRatios.slice(0, idx).reduce((a, b) => a + b, 0);
    const planWidthFrac = state.planRatios[idx];

    const planBar = document.createElement('div');
    planBar.className = 'gantt-plan-bar';
    planBar.style.left = (planStartFrac * 100) + '%';
    planBar.style.width = (planWidthFrac * 100) + '%';
    planBar.style.background = p.color;
    track.appendChild(planBar);

    const done = getTotal(p.id);
    const actualFrac = planWidthFrac * (done / pages);

    const actualBar = document.createElement('div');
    actualBar.className = 'gantt-actual-bar';
    actualBar.style.left = (planStartFrac * 100) + '%';
    actualBar.style.width = (actualFrac * 100) + '%';
    actualBar.style.background = p.color;

    if (done > 0) {
      const actualLabel = document.createElement('div');
      actualLabel.className = 'gantt-actual-label';
      actualLabel.textContent = `${done}/${pages}`;
      actualBar.appendChild(actualLabel);
    }
    track.appendChild(actualBar);

    const fc = forecastData[idx];
    if (fc.widthFrac > 0) {
      const planEndFrac = planStartFrac + planWidthFrac;
      const forecastEndFrac = fc.startFrac + fc.widthFrac;
      const isLate = forecastEndFrac > planEndFrac + 0.01;

      const forecastBar = document.createElement('div');
      forecastBar.className = `gantt-forecast-bar ${isLate ? 'late' : 'on-track'}`;
      forecastBar.style.left = (fc.startFrac * 100) + '%';
      forecastBar.style.width = (fc.widthFrac * 100) + '%';
      track.appendChild(forecastBar);
    }

    row.appendChild(track);
    timeline.appendChild(row);
  });

  // ‚îÄ‚îÄ Today line ‚îÄ‚îÄ
  const todayPct = Math.min(100, Math.max(0, (todayOffset / totalDays) * 100));
  const totalTimelineHeight = 36 + 12 + (36 + 6) * 4;
  const todayLine = document.createElement('div');
  todayLine.className = 'gantt-vline today-line';
  todayLine.style.left = todayPct + '%';
  todayLine.style.height = totalTimelineHeight + 'px';
  todayLine.innerHTML = `<div class="gantt-vline-label">‰ªäÊó•</div>`;
  timeline.appendChild(todayLine);

  // ‚îÄ‚îÄ Deadline line ‚îÄ‚îÄ
  const deadlineLine = document.createElement('div');
  deadlineLine.className = 'gantt-vline deadline-line';
  deadlineLine.style.left = '100%';
  deadlineLine.style.height = totalTimelineHeight + 'px';
  deadlineLine.innerHTML = `<div class="gantt-vline-label">Á∑†Âàá</div>`;
  timeline.appendChild(deadlineLine);

  chart.appendChild(timeline);

  // ‚îÄ‚îÄ Info panel ‚îÄ‚îÄ
  const info = document.getElementById('ganttInfo');
  const daysLeft = daysBetween(today, deadline);

  const lastFc = forecastData[forecastData.length - 1];
  const totalForecastEndFrac = lastFc.startFrac + lastFc.widthFrac;
  const totalForecastDays = Math.ceil(totalForecastEndFrac * totalDays);
  const overUnder = totalForecastDays - totalDays;

  let infoHtml;
  if (overUnder > 0) {
    infoHtml = `Á∑†Âàá„Åæ„Åß <strong>${daysLeft}Êó•</strong> ÔΩú ÊÉ≥ÂÆö <strong>${totalForecastDays}Êó•</strong>Ôºà‚ö† ${overUnder}Êó•Ë∂ÖÈÅéÔºâ`;
  } else {
    infoHtml = `Á∑†Âàá„Åæ„Åß <strong>${daysLeft}Êó•</strong> ÔΩú ÊÉ≥ÂÆö <strong>${totalForecastDays}Êó•</strong>Ôºà${Math.abs(overUnder)}Êó•„ÅÆ‰ΩôË£ïÔºâ`;
  }

  info.innerHTML = infoHtml;

  // ‚îÄ‚îÄ Pace Analysis (Â§âÊõ¥4) ‚îÄ‚îÄ
  renderPaceAnalysis();
}

// ‚îÄ‚îÄ Pace Analysis ‚îÄ‚îÄ
function renderPaceAnalysis() {
  const container = document.getElementById('paceAnalysis');
  const pages = state.totalPages;
  const startStr = document.getElementById('projStart').value;
  const deadlineStr = document.getElementById('projDeadline').value;
  const projStart = parseDate(startStr);
  const deadline = parseDate(deadlineStr);
  const totalDays = Math.max(1, daysBetween(projStart, deadline));
  const daysLeft = daysBetween(today, deadline);

  let html = '<div class="pace-analysis"><div class="pace-analysis-title">Â∑•Á®ãÂà•„Éö„Éº„ÇπÂàÜÊûê</div>';
  let totalDeviation = 0; // Ë®àÁîª„Å´ÂØæ„Åô„ÇãÂêàË®àÂ∑ÆÂàÜÔºàÊ≠£=Ë∂ÖÈÅé„ÄÅË≤†=‰ΩôË£ïÔºâ
  let hasAnyPace = false;

  PROCESSES.forEach((p, idx) => {
    const pace = calcPace(p.id);
    const done = getTotal(p.id);
    const remaining = Math.max(0, pages - done);
    const planDays = Math.round(state.planRatios[idx] * totalDays);

    if (pace) {
      hasAnyPace = true;
      const forecastTotal = Math.ceil(pages / pace.pace);
      const forecastRemaining = remaining > 0 ? Math.ceil(remaining / pace.pace) : 0;
      const deviation = forecastTotal - planDays; // Ë®àÁîªÊØî„ÅÆÂ∑ÆÂàÜ

      totalDeviation += deviation;

      html += `<div class="pace-process">`;
      html += `<span class="pace-process-name" style="color:${p.color}">${p.label}</span>: ${done}/${pages}„Éö„Éº„Ç∏`;
      html += ` (${pace.days}Êó•Èñì„Åß${pace.totalStickers}„Éö„Éº„Ç∏ = ${pace.pace.toFixed(1)}„Éö„Éº„Ç∏/Êó•)`;
      html += `<div class="pace-process-detail">`;
      html += `Ë®àÁîª${planDays}Êó• ‚Üí ÊÉ≥ÂÆö${forecastTotal}Êó•`;
      if (deviation > 0) {
        html += ` (‚ö† +${deviation}Êó•)`;
      } else if (deviation < 0) {
        html += ` (${deviation}Êó•)`;
      } else {
        html += ` (¬±0)`;
      }
      if (remaining > 0) {
        html += ` ÔΩú ÊÆã„Çä${remaining}„Éö„Éº„Ç∏ ‚Üí Á¥Ñ${forecastRemaining}Êó•`;
      } else {
        html += ` ÔΩú ÂÆå‰∫ÜÊ∏à„Åø`;
      }
      html += `</div></div>`;
    } else {
      // „Éö„Éº„Çπ„Éá„Éº„Çø„Å™„Åó ‚Üí Ë®àÁîªÈÄö„Çä„Å®‰ªÆÂÆöÔºàÂ∑ÆÂàÜ0Ôºâ
      html += `<div class="pace-process">`;
      html += `<span class="pace-process-name" style="color:${p.color}">${p.label}</span>: ${done}/${pages}„Éö„Éº„Ç∏`;
      html += `<div class="pace-process-detail">Ë®àÁîª${planDays}Êó• („Éá„Éº„Çø‰∏çË∂≥ ‚Üí Ë®àÁîªÈÄö„Çä„Å®‰ªÆÂÆö)</div>`;
      html += `</div>`;
    }
  });

  if (!hasAnyPace) {
    html += `<div class="cal-detail-empty">„Åæ„Å†ÂçÅÂàÜ„Å™„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
  } else {
    const devDays = Math.round(totalDeviation);
    if (devDays > 0) {
      html += `<div class="pace-summary over">Ë®àÁîª„Å´ÂØæ„Åó„Å¶ ‚ö† ${devDays}Êó•Ë∂ÖÈÅé ÔΩú Á∑†Âàá„Åæ„Åß${daysLeft}Êó•</div>`;
    } else if (devDays < 0) {
      html += `<div class="pace-summary ok">Ë®àÁîª„Å´ÂØæ„Åó„Å¶ ${Math.abs(devDays)}Êó•„ÅÆ‰ΩôË£ï ÔΩú Á∑†Âàá„Åæ„Åß${daysLeft}Êó•</div>`;
    } else {
      html += `<div class="pace-summary ok">Ë®àÁîªÈÄö„Çä„ÅÆ„Éö„Éº„Çπ ÔΩú Á∑†Âàá„Åæ„Åß${daysLeft}Êó•</div>`;
    }
  }

  html += '</div>';
  container.innerHTML = html;
}

// ‚îÄ‚îÄ Drag handle logic ‚îÄ‚îÄ
function positionDragHandles(connectedBar) {
  const handles = connectedBar.querySelectorAll('.gantt-drag-handle');
  const segments = connectedBar.querySelectorAll('.gantt-connected-segment');

  let cumulative = 0;
  handles.forEach((handle, i) => {
    cumulative += segments[i].getBoundingClientRect().width;
    const pct = (cumulative / connectedBar.getBoundingClientRect().width) * 100;
    handle.style.left = pct + '%';
  });
}

function setupDragHandle(handle, index, connectedBar) {
  let isDragging = false;
  let startX = 0;
  let startRatios = [];

  function onStart(clientX) {
    isDragging = true;
    startX = clientX;
    startRatios = [...state.planRatios];
    handle.classList.add('dragging');
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
  }

  function onMove(clientX) {
    if (!isDragging) return;
    const barWidth = connectedBar.getBoundingClientRect().width;
    const dx = clientX - startX;
    const deltaRatio = dx / barWidth;

    const newRatios = [...startRatios];
    const minRatio = 0.08;

    newRatios[index] = startRatios[index] + deltaRatio;
    newRatios[index + 1] = startRatios[index + 1] - deltaRatio;

    if (newRatios[index] < minRatio) {
      newRatios[index + 1] -= (minRatio - newRatios[index]);
      newRatios[index] = minRatio;
    }
    if (newRatios[index + 1] < minRatio) {
      newRatios[index] -= (minRatio - newRatios[index + 1]);
      newRatios[index + 1] = minRatio;
    }

    if (newRatios.some(r => r < minRatio)) return;

    state.planRatios = newRatios;

    const segments = connectedBar.querySelectorAll('.gantt-connected-segment');
    segments.forEach((seg, i) => {
      seg.style.flex = state.planRatios[i];
    });

    positionDragHandles(connectedBar);
  }

  function onEnd() {
    if (!isDragging) return;
    isDragging = false;
    handle.classList.remove('dragging');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    renderGantt();
    createTapGrid();
    renderStickers();
  }

  handle.addEventListener('mousedown', e => {
    e.preventDefault();
    e.stopPropagation();
    onStart(e.clientX);
  });
  document.addEventListener('mousemove', e => onMove(e.clientX));
  document.addEventListener('mouseup', () => onEnd());

  handle.addEventListener('touchstart', e => {
    e.preventDefault();
    e.stopPropagation();
    onStart(e.touches[0].clientX);
  }, { passive: false });
  document.addEventListener('touchmove', e => {
    if (isDragging) onMove(e.touches[0].clientX);
  }, { passive: true });
  document.addEventListener('touchend', () => onEnd());
}

// ‚îÄ‚îÄ Calendar (Â§âÊõ¥1) ‚îÄ‚îÄ
function renderCalendar() {
  const year = state.calYear;
  const month = state.calMonth;

  // Update label
  document.getElementById('calMonthLabel').textContent = `${month + 1}Êúà ${year}`;

  const grid = document.getElementById('calendarGrid');
  grid.innerHTML = '';

  // Weekday headers
  const weekdays = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
  weekdays.forEach(w => {
    const hdr = document.createElement('div');
    hdr.className = 'cal-weekday-header';
    hdr.textContent = w;
    grid.appendChild(hdr);
  });

  // First day of month
  const firstDay = new Date(year, month, 1);
  const startWeekday = firstDay.getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  // Previous month fill
  const prevMonthDays = new Date(year, month, 0).getDate();
  for (let i = startWeekday - 1; i >= 0; i--) {
    const day = prevMonthDays - i;
    const prevMonth = month === 0 ? 11 : month - 1;
    const prevYear = month === 0 ? year - 1 : year;
    const dateStr = formatDateStr(prevYear, prevMonth, day);
    grid.appendChild(createCalDay(day, dateStr, true));
  }

  // Current month
  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = formatDateStr(year, month, d);
    grid.appendChild(createCalDay(d, dateStr, false));
  }

  // Next month fill
  const totalCells = startWeekday + daysInMonth;
  const remaining = (7 - (totalCells % 7)) % 7;
  for (let d = 1; d <= remaining; d++) {
    const nextMonth = month === 11 ? 0 : month + 1;
    const nextYear = month === 11 ? year + 1 : year;
    const dateStr = formatDateStr(nextYear, nextMonth, d);
    grid.appendChild(createCalDay(d, dateStr, true));
  }

  // Render detail for selected date
  renderCalendarDetail(state.calSelectedDate);
}

function createCalDay(dayNum, dateStr, isOtherMonth) {
  const cell = document.createElement('div');
  cell.className = 'cal-day';
  if (isOtherMonth) cell.classList.add('other-month');
  if (dateStr === todayStr) cell.classList.add('today');
  if (dateStr === state.calSelectedDate) cell.classList.add('selected');

  const num = document.createElement('div');
  num.className = 'cal-day-num';
  num.textContent = dayNum;
  cell.appendChild(num);

  // Dots for activity
  const dots = document.createElement('div');
  dots.className = 'cal-day-dots';

  const dayData = getDayData(dateStr);

  // Sequential task dot (any process sticker on this day)
  if (dayData.hasSequential) {
    const dot = document.createElement('div');
    dot.className = 'cal-dot';
    dot.style.background = '#e8a0b4';
    dots.appendChild(dot);
  }

  // Daily task dot
  if (dayData.hasDaily) {
    const dot = document.createElement('div');
    dot.className = 'cal-dot';
    dot.style.background = '#c4a6d4';
    dots.appendChild(dot);
  }

  // Event task dot
  if (dayData.hasEvent) {
    const dot = document.createElement('div');
    dot.className = 'cal-dot';
    dot.style.background = '#d4b896';
    dots.appendChild(dot);
  }

  cell.appendChild(dots);

  cell.addEventListener('click', () => {
    state.calSelectedDate = dateStr;
    // Update selection styling
    document.querySelectorAll('.cal-day.selected').forEach(el => el.classList.remove('selected'));
    cell.classList.add('selected');
    renderCalendarDetail(dateStr);
  });

  return cell;
}

function getDayData(dateStr) {
  const result = { hasSequential: false, hasDaily: false, hasEvent: false, details: [] };

  // Check sticker log for sequential tasks
  if (dateStr === todayStr) {
    // Today: use live stickers
    PROCESSES.forEach(p => {
      const count = state.stickers.filter(s => s.process === p.id).length;
      if (count > 0) {
        result.hasSequential = true;
        result.details.push({ type: 'sequential', label: p.label, count, color: p.color });
      }
    });
    // Also check stickerLog for today
    PROCESSES.forEach(p => {
      const logCount = stickerLog.filter(e => e.process === p.id && e.date === dateStr).reduce((s, e) => s + e.count, 0);
      if (logCount > 0) {
        result.hasSequential = true;
        const existing = result.details.find(d => d.type === 'sequential' && d.label === p.label);
        if (existing) {
          existing.count += logCount;
        } else {
          result.details.push({ type: 'sequential', label: p.label, count: logCount, color: p.color });
        }
      }
    });

    // Daily tasks for today
    DAILY_TASKS.forEach(t => {
      const done = state.dailyDone[t.id] || 0;
      if (done > 0) {
        result.hasDaily = true;
        result.details.push({ type: 'daily', label: t.label, count: done, total: t.count, color: t.color });
      }
    });

    // Event tasks for today
    EVENT_TASKS.filter(t => t.date === dateStr).forEach(t => {
      if (state.eventDone[t.id]) {
        result.hasEvent = true;
        result.details.push({ type: 'event', label: t.label, done: true, color: t.color });
      }
    });
  } else {
    // Past/future: check stickerLog
    PROCESSES.forEach(p => {
      const count = stickerLog.filter(e => e.process === p.id && e.date === dateStr).reduce((s, e) => s + e.count, 0);
      if (count > 0) {
        result.hasSequential = true;
        result.details.push({ type: 'sequential', label: p.label, count, color: p.color });
      }
    });

    // Event tasks on this date
    EVENT_TASKS.filter(t => t.date === dateStr).forEach(t => {
      result.hasEvent = true;
      result.details.push({ type: 'event', label: t.label, done: false, color: t.color });
    });
  }

  return result;
}

function renderCalendarDetail(dateStr) {
  const detail = document.getElementById('calendarDetail');
  const d = parseDate(dateStr);
  const dayData = getDayData(dateStr);

  let html = `<div class="cal-detail-title">${d.getMonth()+1}Êúà${d.getDate()}Êó• (${WEEKDAYS[d.getDay()]})</div>`;

  if (dayData.details.length === 0) {
    html += `<div class="cal-detail-empty">„Åì„ÅÆÊó•„ÅÆË®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
  } else {
    dayData.details.forEach(item => {
      html += `<div class="cal-detail-item">`;
      html += `<div class="cal-detail-dot" style="background:${item.color}"></div>`;
      if (item.type === 'sequential') {
        html += `${item.label}: ${item.count}„Éö„Éº„Ç∏`;
      } else if (item.type === 'daily') {
        html += `${item.label}: ${item.count}/${item.total}Âõû`;
      } else if (item.type === 'event') {
        html += `${item.label}${item.done ? ' (ÂÆå‰∫Ü)' : ''}`;
      }
      html += `</div>`;
    });
  }

  detail.innerHTML = html;
}

// Calendar navigation
document.getElementById('calPrev').addEventListener('click', () => {
  state.calMonth--;
  if (state.calMonth < 0) { state.calMonth = 11; state.calYear--; }
  renderCalendar();
});
document.getElementById('calNext').addEventListener('click', () => {
  state.calMonth++;
  if (state.calMonth > 11) { state.calMonth = 0; state.calYear++; }
  renderCalendar();
});

// ‚îÄ‚îÄ Settings: Daily / Event cards (Â§âÊõ¥3: Á∑®ÈõÜÂØæÂøú) ‚îÄ‚îÄ
function renderSettingsCards() {
  const dailyList = document.getElementById('settingsDailyList');
  dailyList.innerHTML = '';

  DAILY_TASKS.forEach((t, idx) => {
    const row = document.createElement('div');
    row.className = 'task-edit-row';

    // Color selector
    const colors = document.createElement('div');
    colors.className = 'task-edit-colors';
    TASK_COLORS.forEach(c => {
      const btn = document.createElement('div');
      btn.className = 'task-color-btn' + (c === t.color ? ' selected' : '');
      btn.style.background = c;
      btn.addEventListener('click', () => {
        t.color = c;
        renderSettingsCards();
        renderDailyEventRow();
      });
      colors.appendChild(btn);
    });
    row.appendChild(colors);

    // Name input
    const nameInput = document.createElement('input');
    nameInput.className = 'task-edit-input task-edit-input-name';
    nameInput.type = 'text';
    nameInput.value = t.label;
    nameInput.addEventListener('change', () => {
      t.label = nameInput.value || t.label;
      renderDailyEventRow();
    });
    row.appendChild(nameInput);

    // Count input
    const countInput = document.createElement('input');
    countInput.className = 'task-edit-input task-edit-input-count';
    countInput.type = 'number';
    countInput.min = '1';
    countInput.max = '10';
    countInput.value = t.count;
    countInput.addEventListener('change', () => {
      const newCount = Math.max(1, Math.min(10, parseInt(countInput.value) || 1));
      t.count = newCount;
      // Reset done count if it exceeds new count
      if (state.dailyDone[t.id] > newCount) state.dailyDone[t.id] = newCount;
      renderDailyEventRow();
    });
    row.appendChild(countInput);

    // Delete button
    const delBtn = document.createElement('button');
    delBtn.className = 'task-delete-btn';
    delBtn.textContent = '√ó';
    delBtn.addEventListener('click', () => {
      DAILY_TASKS.splice(idx, 1);
      delete state.dailyDone[t.id];
      renderSettingsCards();
      renderDailyEventRow();
    });
    row.appendChild(delBtn);

    dailyList.appendChild(row);
  });

  // Add button for daily
  const addDailyBtn = document.createElement('button');
  addDailyBtn.className = 'task-add-btn';
  addDailyBtn.textContent = 'Ôºã „Éá„Ç§„É™„Éº„Çø„Çπ„ÇØ„ÇíËøΩÂä†';
  addDailyBtn.addEventListener('click', () => {
    const newId = 'daily_' + (nextTaskId++);
    DAILY_TASKS.push({ id: newId, label: 'Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ', count: 1, color: TASK_COLORS[DAILY_TASKS.length % TASK_COLORS.length] });
    state.dailyDone[newId] = 0;
    renderSettingsCards();
    renderDailyEventRow();
  });
  dailyList.appendChild(addDailyBtn);

  // Event tasks
  const eventList = document.getElementById('settingsEventList');
  eventList.innerHTML = '';

  EVENT_TASKS.forEach((t, idx) => {
    const row = document.createElement('div');
    row.className = 'task-edit-row';

    // Color selector
    const colors = document.createElement('div');
    colors.className = 'task-edit-colors';
    TASK_COLORS.forEach(c => {
      const btn = document.createElement('div');
      btn.className = 'task-color-btn' + (c === t.color ? ' selected' : '');
      btn.style.background = c;
      btn.addEventListener('click', () => {
        t.color = c;
        renderSettingsCards();
        renderDailyEventRow();
      });
      colors.appendChild(btn);
    });
    row.appendChild(colors);

    // Name input
    const nameInput = document.createElement('input');
    nameInput.className = 'task-edit-input task-edit-input-name';
    nameInput.type = 'text';
    nameInput.value = t.label;
    nameInput.addEventListener('change', () => {
      t.label = nameInput.value || t.label;
      renderDailyEventRow();
    });
    row.appendChild(nameInput);

    // Date input
    const dateInput = document.createElement('input');
    dateInput.className = 'task-edit-input task-edit-input-date';
    dateInput.type = 'date';
    dateInput.value = t.date;
    dateInput.addEventListener('change', () => {
      t.date = dateInput.value;
      renderDailyEventRow();
    });
    row.appendChild(dateInput);

    // Delete button
    const delBtn = document.createElement('button');
    delBtn.className = 'task-delete-btn';
    delBtn.textContent = '√ó';
    delBtn.addEventListener('click', () => {
      EVENT_TASKS.splice(idx, 1);
      delete state.eventDone[t.id];
      renderSettingsCards();
      renderDailyEventRow();
    });
    row.appendChild(delBtn);

    eventList.appendChild(row);
  });

  // Add button for events
  const addEventBtn = document.createElement('button');
  addEventBtn.className = 'task-add-btn';
  addEventBtn.textContent = 'Ôºã „Ç§„Éô„É≥„Éà„Çø„Çπ„ÇØ„ÇíËøΩÂä†';
  addEventBtn.addEventListener('click', () => {
    const newId = 'evt_' + (nextTaskId++);
    EVENT_TASKS.push({ id: newId, label: 'Êñ∞„Åó„ÅÑ„Ç§„Éô„É≥„Éà', date: todayStr, color: TASK_COLORS[(EVENT_TASKS.length + 2) % TASK_COLORS.length] });
    state.eventDone[newId] = false;
    renderSettingsCards();
    renderDailyEventRow();
  });
  eventList.appendChild(addEventBtn);
}

// ‚îÄ‚îÄ Settings change listeners ‚îÄ‚îÄ
['projPages', 'projStart', 'projDeadline'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => {
    state.totalPages = parseInt(document.getElementById('projPages').value) || 16;
    updateCellHeaders();
  });
});

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
renderDailyEventRow();
renderSettingsCards();
createTapGrid();
renderStickers();
renderCalendar();
goToPage(1);
</script>

  <a class="dl-btn" href="https://github.com/haruhisky/doujin-progress-demo/releases/latest" target="_blank" rel="noopener">
    üì• Á∞°ÊòìPCÁâà„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºàWindowsÔºâ
  </a>
</div><!-- /.wantap-area -->

<!-- ‚ïê‚ïê Work Mate „Ç®„É™„Ç¢ ‚ïê‚ïê -->
<div class="app-section workmate-area">
  <div class="app-header">
    <div class="app-title">Work Mate</div>
    <div class="app-tagline">„ÅÇ„Å™„Åü„ÅÆ‰ΩúÊ•≠„Çí„ÄÅÈùô„Åã„Å´Ë¶ãÂÆà„Çã„ÄÇ<br>„ÇØ„É™„Ç®„Ç§„Çø„Éº„ÅÆ„Åü„ÇÅ„ÅÆ„Ç¢„É≥„Éì„Ç®„É≥„Éà‰ΩúÊ•≠„Éà„É©„ÉÉ„Ç´„Éº„ÄÇ</div>
  </div>
  <iframe id="wmDemoFrame" src="https://haruhisky.github.io/workmate/demo-embed.html" loading="lazy" allow="autoplay"></iframe>
  <div class="wm-state-controls">
    <button class="wm-state-btn active" data-state="work">‰ΩúÊ•≠‰∏≠</button>
    <button class="wm-state-btn" data-state="slacking">„Å≤„Å®ÊÅØ‰∏≠</button>
    <button class="wm-state-btn" data-state="break">‰ºëÊÜ©‰∏≠</button>
    <button class="wm-state-btn" data-state="away">Èõ¢Â∏≠‰∏≠</button>
  </div>
  <p class="wm-hint">‚Üë „Éú„Çø„É≥„ÅßÁä∂ÊÖã„ÇíÂàá„ÇäÊõø„Åà„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ</p>
  <a class="wm-link" href="https://haruhisky.github.io/workmate/" target="_blank" rel="noopener">
    Work Mate „ÅÆË©≥Á¥∞„ÇíË¶ã„Çã ‚Üí
  </a>
</div><!-- /.workmate-area -->

<p class="footer-note">&copy; haruhisky</p>

<script>
// WorkMate demo state controls
(function() {
  var frame = document.getElementById('wmDemoFrame');
  var btns = document.querySelectorAll('.wm-state-btn');
  btns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      var state = this.getAttribute('data-state');
      frame.contentWindow.postMessage({ type: 'setState', state: state }, '*');
      btns.forEach(function(b) { b.classList.toggle('active', b.getAttribute('data-state') === state); });
    });
  });
})();
</script>
</body>
</html>
