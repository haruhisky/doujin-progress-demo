<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Âêå‰∫∫„Çè„Çì„Åü„Å£„Å∑</title>
<style>
:root {
  --bg: #faf8f5;
  --card-bg: #ffffff;
  --text: #4a4a4a;
  --text-light: #8a8a8a;
  --border: #e8e4df;
  --shadow: rgba(0,0,0,0.06);

  --name-color: #e8a0b4;
  --name-bg: #fdf0f4;
  --draft-color: #e8b472;
  --draft-bg: #fdf5ec;
  --ink-color: #7baed4;
  --ink-bg: #eef5fb;
  --finish-color: #82b89a;
  --finish-bg: #eef7f2;

  --today-line: #e07070;
  --deadline-line: #c04040;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
  background: #e8e4df;
  color: var(--text);
  overflow: hidden;
  height: 100dvh;
  display: flex;
  justify-content: center;
  align-items: center;
}

.phone-frame {
  width: 390px;
  height: 760px;
  background: var(--bg);
  border-radius: 32px;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  position: relative;
  display: flex;
  flex-direction: column;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header {
  padding: 16px 20px 8px;
  text-align: center;
  flex-shrink: 0;
}
.header h1 {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  letter-spacing: 0.5px;
}

/* ‚îÄ‚îÄ Nav labels ‚îÄ‚îÄ */
.nav-labels {
  display: flex;
  justify-content: center;
  gap: 24px;
  padding: 0 0 10px;
  flex-shrink: 0;
}
.nav-label {
  font-size: 11px;
  color: var(--text-light);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 12px;
  transition: all 0.3s;
}
.nav-label.active {
  color: var(--text);
  background: var(--card-bg);
  font-weight: 600;
}

/* ‚îÄ‚îÄ Nav dots ‚îÄ‚îÄ */
.nav-dots {
  display: flex;
  justify-content: center;
  gap: 8px;
  padding: 6px 0 10px;
  flex-shrink: 0;
}
.nav-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--border);
  transition: background 0.3s, transform 0.3s;
  cursor: pointer;
}
.nav-dot.active {
  background: var(--text-light);
  transform: scale(1.3);
}

/* ‚îÄ‚îÄ Swipe container ‚îÄ‚îÄ */
.swipe-container {
  flex: 1;
  overflow: hidden;
  position: relative;
}
.swipe-track {
  display: flex;
  width: 300%;
  height: 100%;
  transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
.page {
  width: 33.3333%;
  height: 100%;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 0 16px 20px;
}

/* ‚îÄ‚îÄ Today page: variable grid ‚îÄ‚îÄ */
.date-display {
  text-align: center;
  margin-bottom: 10px;
}
.date-display .date {
  font-size: 20px;
  font-weight: 600;
}
.date-display .weekday {
  font-size: 12px;
  color: var(--text-light);
  margin-top: 2px;
}

.tap-grid {
  display: grid;
  grid-template-columns: var(--left-ratio, 1fr) var(--right-ratio, 1fr);
  grid-template-rows: var(--top-ratio, 1fr) var(--bottom-ratio, 1fr);
  gap: 10px;
  flex: 1;
  height: calc(100% - 60px);
  transition: grid-template-columns 0.5s ease, grid-template-rows 0.5s ease;
}

.tap-cell {
  border-radius: 16px;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
  display: flex;
  flex-direction: column;
  transition: transform 0.1s;
}
.tap-cell:active { transform: scale(0.98); }

.tap-cell-main {
  grid-column: 1 / -1;
}
.tap-cell-next {
  grid-row: 2;
  grid-column: 1;
}
.tap-cell-rest-wrap {
  grid-row: 2;
  grid-column: 2;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.tap-cell-rest-wrap .tap-cell {
  flex: 1;
  min-height: 0;
}

.tap-cell.name-cell { background: var(--name-bg); }
.tap-cell.draft-cell { background: var(--draft-bg); }
.tap-cell.ink-cell { background: var(--ink-bg); }
.tap-cell.finish-cell { background: var(--finish-bg); }

.tap-cell-header {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 12px 4px;
  font-size: 12px;
  font-weight: 600;
  pointer-events: none;
  z-index: 2;
}
.tap-cell-header .icon { font-size: 16px; }
.tap-cell-header .progress {
  margin-left: auto;
  font-size: 13px;
  font-weight: 700;
}

.tap-cell.name-cell .tap-cell-header { color: #b06078; }
.tap-cell.draft-cell .tap-cell-header { color: #a07840; }
.tap-cell.ink-cell .tap-cell-header { color: #5080a0; }
.tap-cell.finish-cell .tap-cell-header { color: #508068; }

.tap-cell-stickers {
  flex: 1;
  position: relative;
  pointer-events: none;
}

/* ‚îÄ‚îÄ Stickers (positioned absolutely within cell) ‚îÄ‚îÄ */
.sticker {
  width: 36px; height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 600;
  color: #fff;
  position: absolute;
  animation: stickerBounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  cursor: pointer;
  pointer-events: auto;
  transition: opacity 0.2s;
  z-index: 1;
  touch-action: none;
}
.sticker.name-s { background: var(--name-color); }
.sticker.draft-s { background: var(--draft-color); }
.sticker.ink-s { background: var(--ink-color); }
.sticker.finish-s { background: var(--finish-color); }

.sticker.removing {
  animation: stickerSlideOut 0.3s ease-in forwards;
}
.sticker.removing-shrink {
  animation: stickerRemove 0.3s ease-in forwards;
}

@keyframes stickerBounce {
  0%   { transform: scale(0); opacity: 0; }
  40%  { transform: scale(1.3); opacity: 1; }
  55%  { transform: scale(0.9); }
  70%  { transform: scale(1.05); }
  85%  { transform: scale(0.98); }
  100% { transform: scale(1); opacity: 1; }
}
@keyframes stickerRemove {
  0% { transform: scale(1); opacity: 1; }
  100% { transform: scale(0); opacity: 0; }
}
@keyframes stickerSlideOut {
  0% { transform: translateX(0); opacity: 1; }
  100% { transform: translateX(80px); opacity: 0; }
}

/* Particle */
.particle {
  position: absolute;
  width: 6px; height: 6px;
  border-radius: 50%;
  pointer-events: none;
  z-index: 5;
}

/* ‚îÄ‚îÄ Gantt page ‚îÄ‚îÄ */
.gantt-section-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
  text-align: center;
}
.gantt-legend {
  display: flex;
  gap: 16px;
  justify-content: center;
  margin-bottom: 10px;
  font-size: 11px;
  color: var(--text-light);
}
.gantt-legend span {
  display: flex;
  align-items: center;
  gap: 4px;
}
.legend-swatch {
  display: inline-block;
  width: 12px; height: 12px;
  border-radius: 3px;
}
.legend-swatch.plan { background: var(--text-light); opacity: 0.4; }
.legend-swatch.forecast-combined {
  background: repeating-linear-gradient(
    -45deg,
    rgba(130, 184, 154, 0.5),
    rgba(130, 184, 154, 0.5) 2px,
    transparent 2px,
    transparent 4px
  );
  border: 1px dashed #82b89a;
}

.gantt-chart {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 16px 12px;
  box-shadow: 0 2px 8px var(--shadow);
  position: relative;
}

/* Date axis */
.gantt-date-axis {
  display: flex;
  margin-left: 50px;
  margin-bottom: 6px;
  position: relative;
  height: 18px;
}
.gantt-date-tick {
  position: absolute;
  font-size: 9px;
  color: var(--text-light);
  transform: translateX(-50%);
  white-space: nowrap;
  top: 0;
}

/* Timeline area (rows + vertical lines) */
.gantt-timeline {
  position: relative;
  margin-left: 50px;
}

.gantt-row {
  display: flex;
  align-items: center;
  margin-bottom: 6px;
  position: relative;
  height: 36px;
}
.gantt-label {
  position: absolute;
  left: -50px;
  width: 46px;
  font-size: 11px;
  font-weight: 500;
  text-align: right;
}
.gantt-bar-track {
  width: 100%;
  height: 36px;
  position: relative;
  background: #f5f3f0;
  border-radius: 8px;
  overflow: visible;
}

/* Plan bar */
.gantt-plan-bar {
  position: absolute;
  height: 100%;
  border-radius: 8px;
  opacity: 0.25;
  top: 0;
}

/* Actual progress bar */
.gantt-actual-bar {
  position: absolute;
  height: 100%;
  border-radius: 8px;
  top: 0;
  transition: width 0.4s ease;
}
.gantt-actual-label {
  position: absolute;
  right: 4px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 9px;
  font-weight: 600;
  color: #fff;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  white-space: nowrap;
}

/* Forecast overlay */
.gantt-forecast-bar {
  position: absolute;
  height: 100%;
  border-radius: 8px;
  top: 0;
  opacity: 0.35;
  transition: width 0.4s ease, left 0.4s ease;
}
.gantt-forecast-bar.late {
  background: repeating-linear-gradient(
    -45deg,
    transparent,
    transparent 3px,
    rgba(224, 112, 112, 0.3) 3px,
    rgba(224, 112, 112, 0.3) 6px
  );
  border: 2px dashed #e07070;
}
.gantt-forecast-bar.on-track {
  background: repeating-linear-gradient(
    -45deg,
    transparent,
    transparent 3px,
    rgba(130, 184, 154, 0.3) 3px,
    rgba(130, 184, 154, 0.3) 6px
  );
  border: 2px dashed #82b89a;
}

/* Drag handle between processes */
.gantt-drag-handle {
  position: absolute;
  top: 0;
  width: 14px;
  height: 100%;
  cursor: col-resize;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
  transform: translateX(-50%);
}
.gantt-drag-handle::after {
  content: '';
  width: 4px;
  height: 20px;
  border-radius: 2px;
  background: rgba(74,74,74,0.3);
  transition: background 0.2s, height 0.2s;
}
.gantt-drag-handle:hover::after,
.gantt-drag-handle.dragging::after {
  background: rgba(74,74,74,0.6);
  height: 28px;
}

/* Vertical lines */
.gantt-vline {
  position: absolute;
  top: -24px;
  width: 2px;
  z-index: 5;
  pointer-events: none;
}
.gantt-vline.today-line { background: var(--today-line); }
.gantt-vline.deadline-line {
  background: var(--deadline-line);
  border-left: 1px dashed var(--deadline-line);
  width: 1px;
}
.gantt-vline-label {
  position: absolute;
  top: -2px;
  font-size: 8px;
  white-space: nowrap;
  transform: translateX(-50%);
  left: 50%;
}
.gantt-vline.today-line .gantt-vline-label { color: var(--today-line); }
.gantt-vline.deadline-line .gantt-vline-label { color: var(--deadline-line); }

/* Connected plan bar */
.gantt-connected-bar {
  position: relative;
  height: 36px;
  margin-bottom: 12px;
  border-radius: 8px;
  overflow: visible;
  display: flex;
}
.gantt-connected-segment {
  height: 100%;
  position: relative;
  transition: flex 0.2s ease;
}
.gantt-connected-segment:first-child { border-radius: 8px 0 0 8px; }
.gantt-connected-segment:last-child { border-radius: 0 8px 8px 0; }
.gantt-connected-segment-label {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 10px;
  font-weight: 600;
  color: #fff;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  white-space: nowrap;
  pointer-events: none;
}

.gantt-info {
  margin-top: 12px;
  padding: 10px 14px;
  background: var(--name-bg);
  border-radius: 12px;
  font-size: 13px;
  line-height: 1.5;
  color: #806068;
  text-align: center;
}

/* ‚îÄ‚îÄ Settings page ‚îÄ‚îÄ */
.settings-card {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 2px 8px var(--shadow);
  margin-bottom: 16px;
}
.settings-card h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text);
}
.setting-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}
.setting-row:last-child { border-bottom: none; }
.setting-label { color: var(--text); }
.setting-value {
  color: var(--text-light);
  font-weight: 500;
  text-align: right;
}
.setting-value input {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 4px 8px;
  font-size: 13px;
  width: 120px;
  text-align: right;
  color: var(--text);
  background: var(--bg);
}
.process-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.process-item {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
}
.process-dot {
  width: 14px; height: 14px;
  border-radius: 50%;
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
.toast {
  position: absolute;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: rgba(74,74,74,0.9);
  color: #fff;
  font-size: 12px;
  padding: 8px 16px;
  border-radius: 20px;
  opacity: 0;
  transition: all 0.3s;
  pointer-events: none;
  z-index: 10;
  white-space: nowrap;
}
.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

@media (max-width: 420px) {
  body { align-items: flex-start; }
  .phone-frame {
    width: 100%;
    height: 100dvh;
    border-radius: 0;
    box-shadow: none;
  }
}
</style>
</head>
<body>

<div class="phone-frame">
  <div class="header">
    <h1>Âêå‰∫∫„Çè„Çì„Åü„Å£„Å∑</h1>
  </div>

  <div class="nav-labels">
    <div class="nav-label" data-page="0">„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà</div>
    <div class="nav-label active" data-page="1">‰ªäÊó•„ÅÆÈÄ≤Êçó</div>
    <div class="nav-label" data-page="2">Ë®≠ÂÆö</div>
  </div>

  <div class="nav-dots">
    <div class="nav-dot" data-page="0"></div>
    <div class="nav-dot active" data-page="1"></div>
    <div class="nav-dot" data-page="2"></div>
  </div>

  <div class="swipe-container">
    <div class="swipe-track" id="swipeTrack">

      <!-- „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà -->
      <div class="page" id="pageGantt">
        <div class="gantt-section-title">„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà</div>
        <div class="gantt-legend">
          <span><span class="legend-swatch plan"></span>Ë®àÁîª</span>
          <span><span class="legend-swatch forecast-combined"></span>ÊÉ≥ÂÆö</span>
        </div>
        <div class="gantt-chart" id="ganttChart"></div>
        <div class="gantt-info" id="ganttInfo"></div>
      </div>

      <!-- ‰ªäÊó•„ÅÆÈÄ≤Êçó -->
      <div class="page" id="pageToday">
        <div class="date-display">
          <div class="date" id="todayDate"></div>
          <div class="weekday" id="todayWeekday"></div>
        </div>
        <div class="tap-grid" id="tapGrid"></div>
      </div>

      <!-- Ë®≠ÂÆö -->
      <div class="page" id="pageSettings">
        <div class="settings-card">
          <h3>„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±</h3>
          <div class="setting-row">
            <span class="setting-label">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç</span>
            <span class="setting-value"><input type="text" id="projName" value="Â§è„Ç≥„ÉüÊñ∞Âàä"></span>
          </div>
          <div class="setting-row">
            <span class="setting-label">Á∑è„Éö„Éº„Ç∏Êï∞</span>
            <span class="setting-value"><input type="number" id="projPages" value="16" min="1" max="999"></span>
          </div>
          <div class="setting-row">
            <span class="setting-label">ÈñãÂßãÊó•</span>
            <span class="setting-value"><input type="date" id="projStart" value="2026-02-20"></span>
          </div>
          <div class="setting-row">
            <span class="setting-label">Á∑†ÂàáÊó•</span>
            <span class="setting-value"><input type="date" id="projDeadline" value="2026-04-15"></span>
          </div>
        </div>
        <div class="settings-card">
          <h3>Â∑•Á®ã</h3>
          <div class="process-list">
            <div class="process-item">
              <div class="process-dot" style="background:var(--name-color)"></div>
              <span>„Éç„Éº„É†</span>
            </div>
            <div class="process-item">
              <div class="process-dot" style="background:var(--draft-color)"></div>
              <span>‰∏ãÊõ∏„Åç</span>
            </div>
            <div class="process-item">
              <div class="process-dot" style="background:var(--ink-color)"></div>
              <span>„Éö„É≥ÂÖ•„Çå</span>
            </div>
            <div class="process-item">
              <div class="process-dot" style="background:var(--finish-color)"></div>
              <span>‰ªï‰∏ä„Åí</span>
            </div>
          </div>
        </div>
        <div class="settings-card">
          <h3>„Åì„ÅÆ„Éá„É¢„Å´„Å§„ÅÑ„Å¶</h3>
          <p style="font-size:12px;color:var(--text-light);line-height:1.6;">
            „Ç∑„Éº„É´ÂºèÈÄ≤ÊçóÁÆ°ÁêÜ„ÅÆ„Ç≥„É≥„Çª„Éó„Éà„Éá„É¢ v3„Åß„Åô„ÄÇÂêÑ„Ç®„É™„Ç¢„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Ç∑„Éº„É´„ÇíË≤º„Çä„ÄÅÊ®™„Çπ„ÉØ„Ç§„Éó„ÅßÂâ•„Åå„Åõ„Åæ„Åô„ÄÇ„Éá„Éº„Çø„ÅØ„Éö„Éº„Ç∏ÂÜÖ„ÅÆ„Åø„Å´‰øùÊåÅ„Åï„Çå„Åæ„Åô„ÄÇ
          </p>
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
// ‚îÄ‚îÄ Process definitions ‚îÄ‚îÄ
const PROCESSES = [
  { id: 'name', label: '„Éç„Éº„É†', icon: '‚úèÔ∏è', cls: 'name', stickerCls: 'name-s', cellCls: 'name-cell', color: '#e8a0b4' },
  { id: 'draft', label: '‰∏ãÊõ∏„Åç', icon: 'üìù', cls: 'draft', stickerCls: 'draft-s', cellCls: 'draft-cell', color: '#e8b472' },
  { id: 'ink', label: '„Éö„É≥ÂÖ•„Çå', icon: 'üñäÔ∏è', cls: 'ink', stickerCls: 'ink-s', cellCls: 'ink-cell', color: '#7baed4' },
  { id: 'finish', label: '‰ªï‰∏ä„Åí', icon: '‚ú®', cls: 'finish', stickerCls: 'finish-s', cellCls: 'finish-cell', color: '#82b89a' },
];

// ‚îÄ‚îÄ Sample sticker log (historical data for demo) ‚îÄ‚îÄ
const stickerLog = [
  { process: 'name', date: '2026-02-20', count: 2 },
  { process: 'name', date: '2026-02-21', count: 2 },
  { process: 'name', date: '2026-02-22', count: 1 },
  { process: 'name', date: '2026-02-24', count: 1 },
  { process: 'name', date: '2026-02-25', count: 1 },
  { process: 'draft', date: '2026-02-23', count: 1 },
  { process: 'draft', date: '2026-02-25', count: 1 },
  { process: 'draft', date: '2026-02-26', count: 1 },
];

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
const state = {
  currentPage: 1,
  totalPages: 16,
  stickers: [], // today's stickers: { process, x, y, timestamp }
  planRatios: [0.25, 0.25, 0.25, 0.25],
};

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
const today = new Date();
const todayStr = today.toISOString().slice(0, 10);

function parseDate(str) {
  const [y, m, d] = str.split('-').map(Number);
  return new Date(y, m - 1, d);
}

function daysBetween(d1, d2) {
  return Math.round((d2 - d1) / 86400000);
}

function getHistoryCount(processId) {
  return stickerLog
    .filter(e => e.process === processId)
    .reduce((sum, e) => sum + e.count, 0);
}

function getTodayCount(processId) {
  return state.stickers.filter(s => s.process === processId).length;
}

function getTotal(processId) {
  return getHistoryCount(processId) + getTodayCount(processId);
}

// ‚îÄ‚îÄ Pace calculation ‚îÄ‚îÄ
function calcPace(processId) {
  const startStr = document.getElementById('projStart').value;
  const projStart = parseDate(startStr);

  const logEntries = stickerLog.filter(e => e.process === processId);
  const todayCount = getTodayCount(processId);

  const dateMap = {};
  logEntries.forEach(e => { dateMap[e.date] = (dateMap[e.date] || 0) + e.count; });
  if (todayCount > 0) {
    dateMap[todayStr] = (dateMap[todayStr] || 0) + todayCount;
  }

  const dates = Object.keys(dateMap).sort();
  if (dates.length === 0) return null;

  const totalStickers = Object.values(dateMap).reduce((a, b) => a + b, 0);
  if (totalStickers <= 1) return null;

  const firstDate = parseDate(dates[0]);
  const lastDate = parseDate(dates[dates.length - 1]);

  let periodStart;
  if (processId === 'name') {
    periodStart = projStart;
  } else {
    periodStart = firstDate;
  }

  const days = Math.max(1, daysBetween(periodStart, lastDate) + 1);
  const pace = totalStickers / days;

  return { pace, totalStickers, firstDate, lastDate, periodStart, days };
}

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
const swipeTrack = document.getElementById('swipeTrack');
const navDots = document.querySelectorAll('.nav-dot');
const navLabels = document.querySelectorAll('.nav-label');

function goToPage(idx) {
  state.currentPage = idx;
  swipeTrack.style.transform = `translateX(-${idx * 33.3333}%)`;
  navDots.forEach((d, i) => d.classList.toggle('active', i === idx));
  navLabels.forEach((l, i) => l.classList.toggle('active', i === idx));
  if (idx === 0) renderGantt();
}

navDots.forEach(d => d.addEventListener('click', () => goToPage(+d.dataset.page)));
navLabels.forEach(l => l.addEventListener('click', () => goToPage(+l.dataset.page)));

// Swipe (touch)
let touchStartX = 0, touchStartY = 0, swiping = false;
const swipeContainer = document.querySelector('.swipe-container');

swipeContainer.addEventListener('touchstart', e => {
  touchStartX = e.touches[0].clientX;
  touchStartY = e.touches[0].clientY;
  swiping = true;
}, { passive: true });

swipeContainer.addEventListener('touchend', e => {
  if (!swiping) return;
  swiping = false;
  const dx = e.changedTouches[0].clientX - touchStartX;
  const dy = e.changedTouches[0].clientY - touchStartY;
  if (Math.abs(dx) < 50 || Math.abs(dy) > Math.abs(dx)) return;
  if (dx < 0 && state.currentPage < 2) goToPage(state.currentPage + 1);
  if (dx > 0 && state.currentPage > 0) goToPage(state.currentPage - 1);
}, { passive: true });

// Swipe (mouse - page navigation)
let mouseDown = false, mouseStartX = 0;
swipeContainer.addEventListener('mousedown', e => { mouseDown = true; mouseStartX = e.clientX; });
swipeContainer.addEventListener('mouseup', e => {
  if (!mouseDown) return;
  mouseDown = false;
  const dx = e.clientX - mouseStartX;
  if (Math.abs(dx) < 50) return;
  if (dx < 0 && state.currentPage < 2) goToPage(state.currentPage + 1);
  if (dx > 0 && state.currentPage > 0) goToPage(state.currentPage - 1);
});

// ‚îÄ‚îÄ Date display ‚îÄ‚îÄ
const WEEKDAYS = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
document.getElementById('todayDate').textContent = `${today.getMonth() + 1}Êúà${today.getDate()}Êó•`;
document.getElementById('todayWeekday').textContent = `${WEEKDAYS[today.getDay()]}ÊõúÊó•`;

// ‚îÄ‚îÄ Grid layout calculation ‚îÄ‚îÄ
function calcGridLayout() {
  // Find main process: first process that is not fully completed
  let mainIdx = 0;
  for (let i = 0; i < PROCESSES.length; i++) {
    if (getTotal(PROCESSES[i].id) < state.totalPages) {
      mainIdx = i;
      break;
    }
    // If all are complete, main stays at last
    if (i === PROCESSES.length - 1) mainIdx = i;
  }

  // Next process: next incomplete after main
  let nextIdx = -1;
  for (let i = mainIdx + 1; i < PROCESSES.length; i++) {
    if (getTotal(PROCESSES[i].id) < state.totalPages) {
      nextIdx = i;
      break;
    }
  }

  // Rest: all other processes (maintaining order)
  const restIndices = [];
  for (let i = 0; i < PROCESSES.length; i++) {
    if (i !== mainIdx && i !== nextIdx) {
      restIndices.push(i);
    }
  }

  // Calculate transition ratio based on main process progress
  const mainDone = getTotal(PROCESSES[mainIdx].id);
  const mainProgress = mainDone / state.totalPages;
  const transition = Math.max(0, Math.min(1, (mainProgress - 0.6) / 0.4));

  // Interpolation
  const lerp = (a, b, t) => a + (b - a) * t;
  const topRatio = lerp(55, 30, transition);
  const bottomRatio = 100 - topRatio;
  const leftPct = lerp(50, 65, transition);

  return { mainIdx, nextIdx, restIndices, topRatio, bottomRatio, leftPct };
}

function updateGridLayout() {
  const grid = document.getElementById('tapGrid');
  const layout = calcGridLayout();

  grid.style.setProperty('--top-ratio', `${layout.topRatio}fr`);
  grid.style.setProperty('--bottom-ratio', `${layout.bottomRatio}fr`);
  grid.style.setProperty('--left-ratio', `${layout.leftPct}fr`);
  grid.style.setProperty('--right-ratio', `${100 - layout.leftPct}fr`);
}

// ‚îÄ‚îÄ Variable Tap Grid ‚îÄ‚îÄ
function createTapGrid() {
  const grid = document.getElementById('tapGrid');
  grid.innerHTML = '';

  const layout = calcGridLayout();

  // Set CSS variables
  grid.style.setProperty('--top-ratio', `${layout.topRatio}fr`);
  grid.style.setProperty('--bottom-ratio', `${layout.bottomRatio}fr`);
  grid.style.setProperty('--left-ratio', `${layout.leftPct}fr`);
  grid.style.setProperty('--right-ratio', `${100 - layout.leftPct}fr`);

  // Helper: create a tap cell
  function createCell(p) {
    const cell = document.createElement('div');
    cell.className = `tap-cell ${p.cellCls}`;
    cell.dataset.process = p.id;

    const header = document.createElement('div');
    header.className = 'tap-cell-header';
    header.innerHTML = `<span class="icon">${p.icon}</span><span>${p.label}</span><span class="progress">${getTotal(p.id)}/${state.totalPages}</span>`;
    cell.appendChild(header);

    const stickersArea = document.createElement('div');
    stickersArea.className = 'tap-cell-stickers';
    stickersArea.dataset.process = p.id;
    cell.appendChild(stickersArea);

    cell.addEventListener('click', (e) => {
      if (e.target.classList.contains('sticker')) return;
      const rect = stickersArea.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top) / rect.height) * 100;
      addSticker(p.id, x, y);
    });

    return cell;
  }

  // Main process (top, full width)
  const mainCell = createCell(PROCESSES[layout.mainIdx]);
  mainCell.classList.add('tap-cell-main');
  grid.appendChild(mainCell);

  // Next process (bottom-left)
  if (layout.nextIdx >= 0) {
    const nextCell = createCell(PROCESSES[layout.nextIdx]);
    nextCell.classList.add('tap-cell-next');
    grid.appendChild(nextCell);
  }

  // Rest processes (bottom-right, stacked)
  if (layout.restIndices.length > 0) {
    const restWrap = document.createElement('div');
    restWrap.className = 'tap-cell-rest-wrap';
    layout.restIndices.forEach(idx => {
      restWrap.appendChild(createCell(PROCESSES[idx]));
    });
    grid.appendChild(restWrap);
  }
}

function updateCellHeaders() {
  PROCESSES.forEach(p => {
    const cell = document.querySelector(`.tap-cell[data-process="${p.id}"]`);
    if (!cell) return;
    const progress = cell.querySelector('.tap-cell-header .progress');
    if (progress) {
      progress.textContent = `${getTotal(p.id)}/${state.totalPages}`;
    }
  });
}

// ‚îÄ‚îÄ Particles ‚îÄ‚îÄ
function emitParticles(containerEl, x, y, color) {
  const count = 4 + Math.floor(Math.random() * 2);
  for (let i = 0; i < count; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.style.background = color;
    particle.style.left = x + 'px';
    particle.style.top = y + 'px';
    particle.style.position = 'absolute';

    const angle = (Math.PI * 2 / count) * i + (Math.random() - 0.5) * 0.5;
    const dist = 15 + Math.random() * 15;
    const tx = Math.cos(angle) * dist;
    const ty = Math.sin(angle) * dist;
    particle.style.width = (4 + Math.random() * 3) + 'px';
    particle.style.height = particle.style.width;

    containerEl.appendChild(particle);

    requestAnimationFrame(() => {
      particle.style.transition = 'transform 0.45s ease-out, opacity 0.45s ease-out';
      particle.style.transform = `translate(${tx}px, ${ty}px) scale(0.3)`;
      particle.style.opacity = '0';
    });

    setTimeout(() => particle.remove(), 500);
  }
}

// ‚îÄ‚îÄ Stickers ‚îÄ‚îÄ
function addSticker(processId, xPct, yPct) {
  const total = getTotal(processId);
  if (total >= state.totalPages) {
    showToast(`${PROCESSES.find(p => p.id === processId).label}„ÅØÂÖ®„Éö„Éº„Ç∏ÂÆå‰∫ÜÊ∏à„Åø„Åß„Åô`);
    return;
  }

  // Add random offset (¬±8px equivalent in %)
  const offsetX = (Math.random() - 0.5) * 10;
  const offsetY = (Math.random() - 0.5) * 10;
  const finalX = Math.max(5, Math.min(85, xPct + offsetX));
  const finalY = Math.max(5, Math.min(85, yPct + offsetY));

  // Remember current layout to detect main process change
  const prevLayout = calcGridLayout();

  state.stickers.push({ process: processId, x: finalX, y: finalY, timestamp: Date.now() });

  if (navigator.vibrate) navigator.vibrate(15);

  // Check if main process changed (process fully completed ‚Üí next becomes main)
  const newLayout = calcGridLayout();
  if (newLayout.mainIdx !== prevLayout.mainIdx) {
    // Rebuild the grid with new layout
    createTapGrid();
    renderStickers();
  } else {
    // Just update CSS variables for smooth transition
    updateGridLayout();
    renderStickers();
    updateCellHeaders();
  }
}

function removeSticker(processId, stickerIndex, slideOut) {
  // Find the sticker element
  const container = document.querySelector(`.tap-cell-stickers[data-process="${processId}"]`);
  if (!container) return;
  const stickers = container.querySelectorAll('.sticker');
  const el = stickers[stickerIndex];
  if (el) {
    el.classList.add(slideOut ? 'removing' : 'removing-shrink');
    setTimeout(() => {
      // Find the actual index in state.stickers
      const processStickers = state.stickers
        .map((s, i) => ({ ...s, idx: i }))
        .filter(s => s.process === processId);
      const prevLayout = calcGridLayout();
      if (processStickers[stickerIndex]) {
        state.stickers.splice(processStickers[stickerIndex].idx, 1);
      }
      const newLayout = calcGridLayout();
      if (newLayout.mainIdx !== prevLayout.mainIdx) {
        createTapGrid();
        renderStickers();
      } else {
        updateGridLayout();
        renderStickers();
        updateCellHeaders();
      }
    }, 280);
  }
}

function renderStickers() {
  PROCESSES.forEach(p => {
    const container = document.querySelector(`.tap-cell-stickers[data-process="${p.id}"]`);
    if (!container) return;
    container.querySelectorAll('.sticker, .particle').forEach(el => el.remove());

    const processStickers = state.stickers.filter(s => s.process === p.id);
    processStickers.forEach((s, i) => {
      const el = document.createElement('div');
      el.className = `sticker ${p.stickerCls}`;
      el.textContent = p.icon;
      el.style.left = `calc(${s.x}% - 18px)`;
      el.style.top = `calc(${s.y}% - 18px)`;

      // Swipe/drag to delete
      setupStickerSwipe(el, p.id, i);

      container.appendChild(el);
    });

    // Emit particles for the newest sticker
    if (processStickers.length > 0) {
      const newest = processStickers[processStickers.length - 1];
      const rect = container.getBoundingClientRect();
      if (newest.timestamp > Date.now() - 100) {
        const px = (newest.x / 100) * rect.width;
        const py = (newest.y / 100) * rect.height;
        emitParticles(container, px, py, p.color);
      }
    }
  });
}

// ‚îÄ‚îÄ Swipe-to-delete on stickers ‚îÄ‚îÄ
function setupStickerSwipe(el, processId, stickerIndex) {
  let startX = 0, startY = 0, isDragging = false, startTime = 0;
  let longPressTimer = null;

  function onStart(clientX, clientY, e) {
    startX = clientX;
    startY = clientY;
    isDragging = true;
    startTime = Date.now();
    // Long press fallback
    longPressTimer = setTimeout(() => {
      if (isDragging) {
        isDragging = false;
        removeSticker(processId, stickerIndex, false);
      }
    }, 500);
  }

  function onMove(clientX, clientY) {
    if (!isDragging) return;
    const dx = clientX - startX;
    const dy = clientY - startY;
    // If horizontal movement > threshold, show visual feedback
    if (Math.abs(dx) > 10) {
      el.style.transform = `translateX(${dx}px)`;
      el.style.opacity = Math.max(0.3, 1 - Math.abs(dx) / 100);
      clearTimeout(longPressTimer);
    }
  }

  function onEnd(clientX) {
    clearTimeout(longPressTimer);
    if (!isDragging) return;
    isDragging = false;
    const dx = clientX - startX;

    if (Math.abs(dx) >= 50) {
      // Swipe delete
      removeSticker(processId, stickerIndex, true);
    } else {
      // Reset position
      el.style.transform = '';
      el.style.opacity = '';
    }
  }

  // Touch events
  el.addEventListener('touchstart', (e) => {
    e.stopPropagation();
    const t = e.touches[0];
    onStart(t.clientX, t.clientY, e);
  }, { passive: true });

  el.addEventListener('touchmove', (e) => {
    e.stopPropagation();
    const t = e.touches[0];
    onMove(t.clientX, t.clientY);
  }, { passive: true });

  el.addEventListener('touchend', (e) => {
    e.stopPropagation();
    const t = e.changedTouches[0];
    onEnd(t.clientX);
    e.preventDefault(); // prevent click from firing
  });

  // Mouse events
  el.addEventListener('mousedown', (e) => {
    e.stopPropagation();
    e.preventDefault();
    onStart(e.clientX, e.clientY, e);

    const onMouseMove = (me) => onMove(me.clientX, me.clientY);
    const onMouseUp = (me) => {
      onEnd(me.clientX);
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    };
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  });

  // Prevent click from bubbling to cell (which would add a sticker)
  el.addEventListener('click', (e) => {
    e.stopPropagation();
  });
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
let toastTimer;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2000);
}

// ‚îÄ‚îÄ Gantt chart ‚îÄ‚îÄ
function renderGantt() {
  const pages = parseInt(document.getElementById('projPages').value) || 16;
  state.totalPages = pages;

  const startStr = document.getElementById('projStart').value;
  const deadlineStr = document.getElementById('projDeadline').value;
  const projStart = parseDate(startStr);
  const deadline = parseDate(deadlineStr);
  const totalDays = Math.max(1, daysBetween(projStart, deadline));
  const todayOffset = daysBetween(projStart, today);

  const chart = document.getElementById('ganttChart');
  chart.innerHTML = '';

  const chartWidth = chart.clientWidth - 24;
  const barAreaWidth = chartWidth - 50;

  // ‚îÄ‚îÄ Date axis ‚îÄ‚îÄ
  const dateAxis = document.createElement('div');
  dateAxis.className = 'gantt-date-axis';
  dateAxis.style.width = barAreaWidth + 'px';

  const tickCount = 7;
  for (let i = 0; i < tickCount; i++) {
    const frac = i / (tickCount - 1);
    const d = new Date(projStart.getTime() + totalDays * frac * 86400000);
    const tick = document.createElement('div');
    tick.className = 'gantt-date-tick';
    tick.style.left = (frac * 100) + '%';
    tick.textContent = `${d.getMonth() + 1}/${d.getDate()}`;
    dateAxis.appendChild(tick);
  }
  chart.appendChild(dateAxis);

  // ‚îÄ‚îÄ Timeline container ‚îÄ‚îÄ
  const timeline = document.createElement('div');
  timeline.className = 'gantt-timeline';
  timeline.style.width = barAreaWidth + 'px';

  // ‚îÄ‚îÄ Connected plan bar ‚îÄ‚îÄ
  const connectedBar = document.createElement('div');
  connectedBar.className = 'gantt-connected-bar';
  connectedBar.style.width = '100%';

  PROCESSES.forEach((p, idx) => {
    const seg = document.createElement('div');
    seg.className = 'gantt-connected-segment';
    seg.style.flex = state.planRatios[idx];
    seg.style.background = p.color;
    seg.style.opacity = '0.5';

    const label = document.createElement('div');
    label.className = 'gantt-connected-segment-label';
    label.textContent = p.label;
    seg.appendChild(label);

    connectedBar.appendChild(seg);
  });

  for (let i = 0; i < 3; i++) {
    const handle = document.createElement('div');
    handle.className = 'gantt-drag-handle';
    handle.dataset.index = i;
    connectedBar.appendChild(handle);
    setupDragHandle(handle, i, connectedBar);
  }

  timeline.appendChild(connectedBar);
  requestAnimationFrame(() => positionDragHandles(connectedBar));

  // ‚îÄ‚îÄ Forecast data ‚îÄ‚îÄ
  const forecastData = [];
  let chainEndDayOffset = 0;

  PROCESSES.forEach((p, idx) => {
    const pace = calcPace(p.id);
    if (pace) {
      const forecastDays = pages / pace.pace;
      const startFrac = chainEndDayOffset / totalDays;
      const widthFrac = forecastDays / totalDays;
      forecastData.push({ startFrac, widthFrac, hasPace: true });
      chainEndDayOffset += forecastDays;
    } else {
      forecastData.push({ startFrac: 0, widthFrac: 0, hasPace: false });
    }
  });

  const noPaceIndices = forecastData
    .map((d, i) => d.hasPace ? -1 : i)
    .filter(i => i >= 0);

  if (noPaceIndices.length > 0) {
    let lastPaceEnd = 0;
    for (let i = 0; i < forecastData.length; i++) {
      if (forecastData[i].hasPace) {
        lastPaceEnd = forecastData[i].startFrac + forecastData[i].widthFrac;
      }
    }
    const remainingFrac = Math.max(0, 1 - lastPaceEnd);
    const eachFrac = noPaceIndices.length > 0 ? remainingFrac / noPaceIndices.length : 0;
    let cursor = lastPaceEnd;
    noPaceIndices.forEach(i => {
      forecastData[i].startFrac = cursor;
      forecastData[i].widthFrac = eachFrac;
      cursor += eachFrac;
    });
  }

  // ‚îÄ‚îÄ Process rows ‚îÄ‚îÄ
  PROCESSES.forEach((p, idx) => {
    const row = document.createElement('div');
    row.className = 'gantt-row';

    const label = document.createElement('div');
    label.className = 'gantt-label';
    label.textContent = p.label;
    row.appendChild(label);

    const track = document.createElement('div');
    track.className = 'gantt-bar-track';

    const planStartFrac = state.planRatios.slice(0, idx).reduce((a, b) => a + b, 0);
    const planWidthFrac = state.planRatios[idx];

    const planBar = document.createElement('div');
    planBar.className = 'gantt-plan-bar';
    planBar.style.left = (planStartFrac * 100) + '%';
    planBar.style.width = (planWidthFrac * 100) + '%';
    planBar.style.background = p.color;
    track.appendChild(planBar);

    const done = getTotal(p.id);
    const actualFrac = planWidthFrac * (done / pages);

    const actualBar = document.createElement('div');
    actualBar.className = 'gantt-actual-bar';
    actualBar.style.left = (planStartFrac * 100) + '%';
    actualBar.style.width = (actualFrac * 100) + '%';
    actualBar.style.background = p.color;

    if (done > 0) {
      const actualLabel = document.createElement('div');
      actualLabel.className = 'gantt-actual-label';
      actualLabel.textContent = `${done}/${pages}`;
      actualBar.appendChild(actualLabel);
    }
    track.appendChild(actualBar);

    const fc = forecastData[idx];
    if (fc.widthFrac > 0) {
      const planEndFrac = planStartFrac + planWidthFrac;
      const forecastEndFrac = fc.startFrac + fc.widthFrac;
      const isLate = forecastEndFrac > planEndFrac + 0.01;

      const forecastBar = document.createElement('div');
      forecastBar.className = `gantt-forecast-bar ${isLate ? 'late' : 'on-track'}`;
      forecastBar.style.left = (fc.startFrac * 100) + '%';
      forecastBar.style.width = (fc.widthFrac * 100) + '%';
      track.appendChild(forecastBar);
    }

    row.appendChild(track);
    timeline.appendChild(row);
  });

  // ‚îÄ‚îÄ Today line ‚îÄ‚îÄ
  const todayPct = Math.min(100, Math.max(0, (todayOffset / totalDays) * 100));
  const totalTimelineHeight = 36 + 12 + (36 + 6) * 4;
  const todayLine = document.createElement('div');
  todayLine.className = 'gantt-vline today-line';
  todayLine.style.left = todayPct + '%';
  todayLine.style.height = totalTimelineHeight + 'px';
  todayLine.innerHTML = `<div class="gantt-vline-label">‰ªäÊó•</div>`;
  timeline.appendChild(todayLine);

  // ‚îÄ‚îÄ Deadline line ‚îÄ‚îÄ
  const deadlineLine = document.createElement('div');
  deadlineLine.className = 'gantt-vline deadline-line';
  deadlineLine.style.left = '100%';
  deadlineLine.style.height = totalTimelineHeight + 'px';
  deadlineLine.innerHTML = `<div class="gantt-vline-label">Á∑†Âàá</div>`;
  timeline.appendChild(deadlineLine);

  chart.appendChild(timeline);

  // ‚îÄ‚îÄ Info panel (simplified) ‚îÄ‚îÄ
  const info = document.getElementById('ganttInfo');
  const daysLeft = daysBetween(today, deadline);

  const lastFc = forecastData[forecastData.length - 1];
  const totalForecastEndFrac = lastFc.startFrac + lastFc.widthFrac;
  const totalForecastDays = Math.ceil(totalForecastEndFrac * totalDays);
  const overUnder = totalForecastDays - totalDays;

  let infoHtml;
  if (overUnder > 0) {
    infoHtml = `Á∑†Âàá„Åæ„Åß <strong>${daysLeft}Êó•</strong> ÔΩú ÊÉ≥ÂÆö <strong>${totalForecastDays}Êó•</strong>Ôºà‚ö† ${overUnder}Êó•Ë∂ÖÈÅéÔºâ`;
  } else {
    infoHtml = `Á∑†Âàá„Åæ„Åß <strong>${daysLeft}Êó•</strong> ÔΩú ÊÉ≥ÂÆö <strong>${totalForecastDays}Êó•</strong>Ôºà${Math.abs(overUnder)}Êó•„ÅÆ‰ΩôË£ïÔºâ`;
  }

  info.innerHTML = infoHtml;
}

// ‚îÄ‚îÄ Drag handle logic ‚îÄ‚îÄ
function positionDragHandles(connectedBar) {
  const handles = connectedBar.querySelectorAll('.gantt-drag-handle');
  const segments = connectedBar.querySelectorAll('.gantt-connected-segment');

  let cumulative = 0;
  handles.forEach((handle, i) => {
    cumulative += segments[i].getBoundingClientRect().width;
    const pct = (cumulative / connectedBar.getBoundingClientRect().width) * 100;
    handle.style.left = pct + '%';
  });
}

function setupDragHandle(handle, index, connectedBar) {
  let isDragging = false;
  let startX = 0;
  let startRatios = [];

  function onStart(clientX) {
    isDragging = true;
    startX = clientX;
    startRatios = [...state.planRatios];
    handle.classList.add('dragging');
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
  }

  function onMove(clientX) {
    if (!isDragging) return;
    const barWidth = connectedBar.getBoundingClientRect().width;
    const dx = clientX - startX;
    const deltaRatio = dx / barWidth;

    const newRatios = [...startRatios];
    const minRatio = 0.08;

    newRatios[index] = startRatios[index] + deltaRatio;
    newRatios[index + 1] = startRatios[index + 1] - deltaRatio;

    if (newRatios[index] < minRatio) {
      newRatios[index + 1] -= (minRatio - newRatios[index]);
      newRatios[index] = minRatio;
    }
    if (newRatios[index + 1] < minRatio) {
      newRatios[index] -= (minRatio - newRatios[index + 1]);
      newRatios[index + 1] = minRatio;
    }

    if (newRatios.some(r => r < minRatio)) return;

    state.planRatios = newRatios;

    const segments = connectedBar.querySelectorAll('.gantt-connected-segment');
    segments.forEach((seg, i) => {
      seg.style.flex = state.planRatios[i];
    });

    positionDragHandles(connectedBar);
  }

  function onEnd() {
    if (!isDragging) return;
    isDragging = false;
    handle.classList.remove('dragging');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    renderGantt();
  }

  handle.addEventListener('mousedown', e => {
    e.preventDefault();
    e.stopPropagation();
    onStart(e.clientX);
  });
  document.addEventListener('mousemove', e => onMove(e.clientX));
  document.addEventListener('mouseup', () => onEnd());

  handle.addEventListener('touchstart', e => {
    e.preventDefault();
    e.stopPropagation();
    onStart(e.touches[0].clientX);
  }, { passive: false });
  document.addEventListener('touchmove', e => {
    if (isDragging) onMove(e.touches[0].clientX);
  }, { passive: true });
  document.addEventListener('touchend', () => onEnd());
}

// ‚îÄ‚îÄ Settings change listeners ‚îÄ‚îÄ
['projPages', 'projStart', 'projDeadline'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => {
    state.totalPages = parseInt(document.getElementById('projPages').value) || 16;
    updateCellHeaders();
  });
});

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
createTapGrid();
renderStickers();
goToPage(1);
</script>
</body>
</html>
